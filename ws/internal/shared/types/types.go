package types

import (
	"sync"
	"time"
)

// LogLevel represents log verbosity level
type LogLevel string

const (
	LogLevelDebug LogLevel = "debug"
	LogLevelInfo  LogLevel = "info"
	LogLevelWarn  LogLevel = "warn"
	LogLevelError LogLevel = "error"
	LogLevelFatal LogLevel = "fatal"
)

// LogFormat represents log output format
type LogFormat string

const (
	LogFormatJSON   LogFormat = "json"   // JSON format for Loki
	LogFormatPretty LogFormat = "pretty" // Human-readable for local dev
)

// ServerConfig contains the configuration for the WebSocket server
type ServerConfig struct {
	Addr                 string
	KafkaBrokers         []string
	ConsumerGroup        string
	DisableKafkaConsumer bool        // When true, skip Kafka consumer creation (for shared pool mode)
	SharedKafkaConsumer  interface{} // Optional: Shared Kafka consumer for message replay (set when using pool mode)
	MaxConnections       int

	// Static resource limits (explicit configuration)
	CPULimit    float64 // CPU cores available (from docker limit)
	MemoryLimit int64   // Memory bytes available (from docker limit)

	// Rate limiting (prevent overload)
	MaxKafkaMessagesPerSec int // Max Kafka messages consumed per second
	MaxBroadcastsPerSec    int // Max broadcasts per second
	MaxGoroutines          int // Hard goroutine limit

	// Safety thresholds (emergency brakes)
	CPURejectThreshold float64 // Reject new connections above this CPU % (default: 75)
	CPUPauseThreshold  float64 // Pause Kafka consumption above this CPU % (default: 80)

	// Monitoring intervals
	MetricsInterval time.Duration // Metrics collection interval (default: 15s)

	// Logging configuration
	LogLevel  LogLevel  // Log level (default: info)
	LogFormat LogFormat // Log format (default: json)
}

// Stats tracks server statistics
type Stats struct {
	TotalConnections   int64
	CurrentConnections int64
	MessagesSent       int64
	MessagesReceived   int64
	BytesSent          int64
	BytesReceived      int64
	StartTime          time.Time
	Mu                 sync.RWMutex
	CPUPercent         float64
	MemoryMB           float64

	// Message delivery reliability metrics
	SlowClientsDisconnected int64 // Count of clients disconnected for being too slow
	RateLimitedMessages     int64 // Count of messages dropped due to rate limiting
	MessageReplayRequests   int64 // Count of replay requests served (gap recovery)

	// Phase 2 observability metrics
	DisconnectsByReason        map[string]int64 // Disconnect counts by reason (read_error, write_timeout, etc.)
	DroppedBroadcastsByChannel map[string]int64 // Dropped broadcast counts by channel
	BufferSaturationSamples    []int            // Recent buffer saturation samples (last 100)
	DisconnectsMu              sync.RWMutex     // Protects DisconnectsByReason map
	DropsMu                    sync.RWMutex     // Protects DroppedBroadcastsByChannel map
	BuffersMu                  sync.RWMutex     // Protects BufferSaturationSamples slice

	// Phase 4 logging counters
	DroppedBroadcastLogCounter int64 // Counter for sampled logging (every 100th drop)
}
