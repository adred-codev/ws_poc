# WebSocket Server - Multi-Core Mode (GCP Production)
# Instance: odin-ws-go (dedicated e2-highcpu-8)
# Architecture: 3 shards + load balancer (optimal based on empirical data)
# Connects to Kafka on backend instance via internal network
#
# DEPLOYMENT:
#   1. Set WS_MODE=multi in .env.production
#   2. Set BACKEND_INTERNAL_IP environment variable
#   3. Run: export BACKEND_INTERNAL_IP=10.128.0.2 && docker-compose -f docker-compose.multi.yml up -d
#
# DOCKER RESOURCE LIMITS (e2-highcpu-8: 8 vCPU, 8GB RAM):
#   - ws-multi CPU: 7.0 cores (allocation for 3 shards + system + headroom)
#   - ws-multi Memory: 7.0 GB (85% of available, leaves 1GB for system)
#   - promtail CPU: 1.0 core (log shipping, ~0.05 actual usage)
#   - promtail Memory: 512 MB
#   - Configuration: 18K connections distributed across 3 shards (6K each)

services:
  ws-multi:
    build:
      context: ../../../../../ws
      dockerfile: Dockerfile.multi
    container_name: odin-ws-multi
    ports:
      - "0.0.0.0:3004:3001"  # LoadBalancer port (external:internal)
    command:
      - "./odin-ws-multi"
      - "--shards=${NUM_SHARDS:-3}"
      - "--base-port=${SHARD_BASE_PORT:-3002}"
      - "--lb-addr=${LB_ADDR:-:3001}"
    # Load configuration in priority order (last wins):
    # 1. shared/base.env - Common defaults
    # 2. shared/kafka-topics.env - Topic configuration
    # 3. shared/ports.env - Port mappings
    # 4. overrides.multi.env - GCP multi-core production values (NUM_SHARDS=3)
    # 5. .env.production - Secrets and instance-specific overrides
    # 6. .env.debug - Optional debug overrides (create from .env.debug.template)
    #                 File presence = debug mode, delete to return to production
    env_file:
      - ../../../shared/base.env
      - ../../../shared/kafka-topics.env
      - ../../../shared/ports.env
      - ./overrides.multi.env
      - .env.production
      - .env.debug
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "${WS_CPU_LIMIT:-7.0}"  # Default 7 cores for multi-core (1 per shard)
          memory: 7168M # 7.0 GB (85% of 8GB on e2-highcpu-8)
    ulimits:
      nofile:
        soft: 200000
        hard: 200000

  promtail:
    image: grafana/promtail:3.3.2
    container_name: odin-ws-promtail
    env_file:
      - .env.production
    volumes:
      - ./promtail-config.yml:/etc/promtail/promtail-config.yml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/promtail-config.yml -config.expand-env=true
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
