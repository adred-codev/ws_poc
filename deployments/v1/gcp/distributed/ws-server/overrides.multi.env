# =============================================================================
# GCP Production Overrides - MULTI-CORE MODE
# =============================================================================
# Purpose: Override shared/base.env for GCP multi-core production deployment
# Load order: base.env → kafka-topics.env → ports.env → overrides.multi.env → .env.production
# Instance: e2-highcpu-8 (8 vCPU, 8GB RAM)
# Target: 18,000+ connections distributed across 7 shards (~2.6K per shard)
#
# Architecture Notes:
#   - Each shard has its own Kafka consumer group (e.g., ws-server-production-0 through -6)
#   - BroadcastBus coordinates message distribution across all shards
#   - LoadBalancer uses "least connections" strategy for even distribution
#   - Per-shard max connections: WS_MAX_CONNECTIONS / 7 shards (~2,571 per shard)

ENVIRONMENT=production-multi

# =============================================================================
# KAFKA CONNECTION
# =============================================================================
# Note: KAFKA_BROKERS is set in .env.production (uses BACKEND_INTERNAL_IP)
# Base consumer group name; shards append -0 through -6 (7 shards total)
KAFKA_GROUP_ID=ws-server-production  # Base name

# =============================================================================
# RESOURCE LIMITS (Multi-Core Distribution)
# =============================================================================
# Strategy: Scale up with e2-highcpu-8 for better CPU capacity
# Previous: e2-standard-4 with 3 shards, 3 CPUs → 5,180/12K (43%) due to CPU throttling
# Current: e2-highcpu-8 with 7 shards, 7 CPUs → Target 12K+ connections (100%)
# CPU: 7 cores total (1 core per shard, 7 shards)
# Memory: 7GB total (85% of 8GB, distributed across shards ~1GB per shard)
WS_CPU_LIMIT=7                # Total CPU limit (Docker distributes across 7 shards)
WS_MEMORY_LIMIT=7516192768    # 7 GB (85% of 8GB) - e2-highcpu-8 has less RAM
WS_MAX_CONNECTIONS=18000      # Total connections (divided by shard count: 18K/7 = ~2,571 per shard)

# =============================================================================
# RATE LIMITING (Production-validated)
# =============================================================================
WS_MAX_KAFKA_RATE=25         # Kafka message consumption rate per shard
WS_MAX_BROADCAST_RATE=25     # Broadcast rate limit per shard

# =============================================================================
# GOROUTINE LIMIT (Calculated for multi-core capacity)
# =============================================================================
# Formula per shard: ((2,571 × 2) + overhead) × 1.2 ≈ 6,500 per shard
# Total: 45,500 for 7 shards (increased from 30K to support more shards)
WS_MAX_GOROUTINES=45500
