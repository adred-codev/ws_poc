version: '3'

vars:
  NODE_VERSION: "18"
  GO_VERSION: "1.25"

tasks:
  setup:
    desc: "âš™ï¸  Initial project setup - install dependencies and build everything"
    cmds:
      - |
        echo "âš™ï¸  Odin WebSocket Project Setup"
        echo "================================"

        # Check prerequisites
        echo "ðŸ” Checking prerequisites..."

        # Check Node.js
        if command -v node &> /dev/null; then
          node_version=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
          echo "âœ… Node.js $(node --version) detected"
        else
          echo "âŒ Node.js not found. Please install Node.js {{.NODE_VERSION}}+"
          exit 1
        fi

        # Check Go
        if command -v go &> /dev/null; then
          echo "âœ… Go $(go version | cut -d' ' -f3) detected"
        else
          echo "âŒ Go not found. Please install Go {{.GO_VERSION}}+"
          exit 1
        fi

        # Check Docker
        if command -v docker &> /dev/null; then
          echo "âœ… Docker $(docker --version | cut -d' ' -f3 | cut -d',' -f1) detected"
        else
          echo "âŒ Docker not found. Please install Docker"
          exit 1
        fi

        # Install Node.js dependencies
        echo ""
        echo "ðŸ“¦ Installing Node.js dependencies..."
        npm ci

        # Setup Go dependencies
        echo ""
        echo "ðŸ“¦ Setting up Go dependencies..."
        task go:deps

        # Build Go server
        echo ""
        echo "ðŸ”¨ Building Go server..."
        task go:build

        # Create necessary directories
        echo ""
        echo "ðŸ“ Creating project directories..."
        mkdir -p logs metrics scripts

        echo ""
        echo "âœ… Setup complete!"
        echo ""
        echo "ðŸš€ Quick start commands:"
        echo "  task start       - Start Node.js stack"
        echo "  task start:go    - Start Go stack"
        echo "  task help        - Show all available commands"

  reset:
    desc: "ðŸ”„ Clean reset - stop everything, clean up, and restart"
    cmds:
      - |
        echo "ðŸ”„ Performing clean reset..."

        # Stop all services
        echo "ðŸ›‘ Stopping all services..."
        task stop

        # Clean up
        echo "ðŸ§¹ Cleaning up..."
        task clean
        task go:clean
        task client:clean

        # Rebuild
        echo "ðŸ”¨ Rebuilding..."
        task go:build

        echo "âœ… Reset complete!"
        echo "ðŸ’¡ Run 'task start' or 'task start:go' to begin"

  check:
    desc: "ðŸ” Check system health and dependencies"
    cmds:
      - |
        echo "ðŸ” System Health Check"
        echo "====================="

        # Check Node.js
        echo "Node.js:"
        if command -v node &> /dev/null; then
          echo "  âœ… $(node --version)"
        else
          echo "  âŒ Not installed"
        fi

        # Check npm
        echo "NPM:"
        if command -v npm &> /dev/null; then
          echo "  âœ… $(npm --version)"
        else
          echo "  âŒ Not installed"
        fi

        # Check Go
        echo "Go:"
        if command -v go &> /dev/null; then
          echo "  âœ… $(go version | cut -d' ' -f3)"
        else
          echo "  âŒ Not installed"
        fi

        # Check Docker
        echo "Docker:"
        if command -v docker &> /dev/null && docker ps &> /dev/null; then
          echo "  âœ… $(docker --version | cut -d' ' -f3 | cut -d',' -f1) (running)"
        elif command -v docker &> /dev/null; then
          echo "  âš ï¸  Installed but not running"
        else
          echo "  âŒ Not installed"
        fi

        # Check Python (for client server)
        echo "Python:"
        if command -v python3 &> /dev/null; then
          echo "  âœ… $(python3 --version)"
        else
          echo "  âš ï¸  Not installed (optional, for client serving)"
        fi

        # Check running services
        echo ""
        echo "Running Services:"
        echo "=================="
        task status 2>/dev/null || echo "âš ï¸  Error checking service status"

  install:tools:
    desc: "ðŸ› ï¸  Install additional development tools"
    cmds:
      - |
        echo "ðŸ› ï¸  Installing Development Tools"
        echo "==============================="

        # Install Go tools
        echo "ðŸ“¦ Installing Go development tools..."
        go install golang.org/x/tools/cmd/goimports@latest || echo "âš ï¸  Failed to install goimports"

        # Install golangci-lint
        if ! command -v golangci-lint &> /dev/null; then
          echo "ðŸ“¦ Installing golangci-lint..."
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin
        else
          echo "âœ… golangci-lint already installed"
        fi

        # Install Task globally (if not already available)
        if ! command -v task &> /dev/null; then
          echo "ðŸ“¦ Installing Task runner..."
          if command -v brew &> /dev/null; then
            brew install go-task/tap/go-task
          else
            echo "âš ï¸  Please install Task manually: https://taskfile.dev/installation/"
          fi
        else
          echo "âœ… Task runner already available"
        fi

        echo "âœ… Development tools installation complete"

  update:
    desc: "ðŸ“ˆ Update all dependencies"
    cmds:
      - |
        echo "ðŸ“ˆ Updating Dependencies"
        echo "======================="

        # Update Node.js dependencies
        echo "ðŸ“¦ Updating Node.js dependencies..."
        npm update

        # Update Go dependencies
        echo "ðŸ“¦ Updating Go dependencies..."
        task go:deps

        echo "âœ… Dependencies updated"

  backup:
    desc: "ðŸ’¾ Create backup of current configuration"
    cmds:
      - |
        timestamp=$(date +%Y%m%d_%H%M%S)
        backup_dir="backups/backup_${timestamp}"

        echo "ðŸ’¾ Creating backup..."
        mkdir -p "${backup_dir}"

        # Backup configuration files
        cp Taskfile.yml "${backup_dir}/"
        cp package.json "${backup_dir}/"
        cp -r tasks/ "${backup_dir}/"
        cp go-server/go.mod "${backup_dir}/"
        cp go-server/config.json "${backup_dir}/"

        # Backup any metrics
        if [ -d "metrics" ] && [ "$(ls -A metrics)" ]; then
          cp -r metrics/ "${backup_dir}/"
        fi

        echo "âœ… Backup created: ${backup_dir}"

  lint:all:
    desc: "ðŸ” Run linting on all code"
    cmds:
      - |
        echo "ðŸ” Running All Linting Checks"
        echo "============================="

        # TypeScript/Node.js linting
        echo "ðŸŸ¢ Node.js linting..."
        task node:lint || echo "âš ï¸  Node.js linting issues found"

        # Go linting
        echo "âš¡ Go linting..."
        task go:lint || echo "âš ï¸  Go linting issues found"

        echo "âœ… Linting complete"

  format:all:
    desc: "ðŸ’… Format all code"
    cmds:
      - |
        echo "ðŸ’… Formatting All Code"
        echo "====================="

        # Format TypeScript
        echo "ðŸŸ¢ Formatting TypeScript..."
        task node:format

        # Format Go
        echo "âš¡ Formatting Go..."
        task go:fmt

        echo "âœ… All code formatted"

  test:all:
    desc: "ðŸ§ª Run all tests"
    cmds:
      - |
        echo "ðŸ§ª Running All Tests"
        echo "==================="

        # TypeScript type checking
        echo "ðŸŸ¢ TypeScript type checking..."
        task node:typecheck

        # Go tests
        echo "âš¡ Go tests..."
        task go:test

        # Connectivity tests
        echo "ðŸ”— Connectivity tests..."
        task test:connectivity

        echo "âœ… All tests complete"

  quality:all:
    desc: "âœ¨ Run all quality checks (format, lint, test)"
    cmds:
      - task: format:all
      - task: lint:all
      - task: test:all
      - echo "âœ… All quality checks passed"

  docs:
    desc: "ðŸ“š Generate and serve documentation"
    cmds:
      - |
        echo "ðŸ“š Documentation"
        echo "==============="
        echo ""
        echo "ðŸ“– Available Documentation:"
        echo "  README.md              - Main project documentation"
        echo "  go-server/README.md    - Go server documentation"
        echo "  LOAD_TESTING.md        - Load testing guide"
        echo ""
        echo "ðŸŒ Online Resources:"
        echo "  Task Commands: task --list"
        echo "  Go Docs: task go:docs (if godoc installed)"
        echo ""
        echo "ðŸ’¡ Quick Reference:"
        echo "  task help             - Show main commands"
        echo "  task start            - Start Node.js stack"
        echo "  task start:go         - Start Go stack"
        echo "  task test:quick       - Quick load test"

  env:
    desc: "ðŸŒ Show environment information"
    cmds:
      - |
        echo "ðŸŒ Environment Information"
        echo "=========================="
        echo "Operating System: $(uname -s) $(uname -r)"
        echo "Architecture: $(uname -m)"
        echo "Shell: $SHELL"
        echo "Working Directory: $(pwd)"
        echo ""
        echo "Node.js: $(node --version 2>/dev/null || echo 'Not installed')"
        echo "NPM: $(npm --version 2>/dev/null || echo 'Not installed')"
        echo "Go: $(go version 2>/dev/null | cut -d' ' -f3 || echo 'Not installed')"
        echo "Docker: $(docker --version 2>/dev/null | cut -d' ' -f3 | cut -d',' -f1 || echo 'Not installed')"
        echo "Python: $(python3 --version 2>/dev/null || echo 'Not installed')"
        echo ""
        echo "Current Git Branch: $(git branch --show-current 2>/dev/null || echo 'Not a git repository')"
        echo "Task Version: $(task --version 2>/dev/null || echo 'Not installed')"