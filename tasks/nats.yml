version: '3'

vars:
  NATS_PORT: "4222"
  NATS_MONITOR_PORT: "8222"

tasks:
  start:
    desc: "ğŸ”Œ Start NATS server with Docker"
    cmds:
      - |
        if ! docker ps | grep -q nats; then
          echo "Starting NATS server..."
          docker-compose up -d nats
          echo "Waiting for NATS to be ready..."
          sleep 3
          echo "âœ… NATS server started on port {{.NATS_PORT}}"
          echo "ğŸ“Š Monitor: http://localhost:{{.NATS_MONITOR_PORT}}"
        else
          echo "âœ… NATS server already running"
        fi

  stop:
    desc: "ğŸ›‘ Stop NATS server"
    cmds:
      - echo "Stopping NATS server..."
      - docker-compose stop nats || true
      - echo "âœ… NATS server stopped"

  restart:
    desc: "ğŸ”„ Restart NATS server"
    cmds:
      - task: stop
      - sleep 2
      - task: start

  logs:
    desc: "ğŸ“œ View NATS server logs"
    cmds:
      - docker-compose logs -f nats

  status:
    desc: "ğŸ“Š Check NATS server status"
    cmds:
      - |
        if docker ps | grep -q nats; then
          echo "âœ… NATS server is running"
          curl -s http://localhost:{{.NATS_MONITOR_PORT}}/varz | jq -r '
            "Server: " + .server_name +
            "\nVersion: " + .version +
            "\nConnections: " + (.connections | tostring) +
            "\nMessages In: " + (.in_msgs | tostring) +
            "\nMessages Out: " + (.out_msgs | tostring) +
            "\nUptime: " + .uptime'
        else
          echo "âŒ NATS server is not running"
          exit 1
        fi

  monitor:
    desc: "ğŸ–¥ï¸  Open NATS monitoring dashboard"
    cmds:
      - open http://localhost:{{.NATS_MONITOR_PORT}}

  clean:
    desc: "ğŸ§¹ Clean up NATS data and stop server"
    cmds:
      - task: stop
      - docker-compose rm -f nats || true
      - echo "âœ… NATS cleanup complete"

  test:
    desc: "ğŸ§ª Test NATS connectivity"
    cmds:
      - |
        echo "Testing NATS connectivity..."
        if curl -s http://localhost:{{.NATS_MONITOR_PORT}}/varz > /dev/null; then
          echo "âœ… NATS server is reachable"
        else
          echo "âŒ NATS server is not reachable"
          exit 1
        fi