version: '3'

vars:
  NODE_SERVER_PORT: "3001"
  GO_SERVER_PORT: "3002"
  METRICS_DIR: "metrics"

tasks:
  # Quick Tests
  quick:
    desc: "ğŸ§ª Quick load test (100 connections) on available server"
    cmds:
      - |
        if curl -s http://localhost:{{.NODE_SERVER_PORT}}/health > /dev/null; then
          echo "ğŸŸ¢ Testing Node.js server..."
          task test:quick:node
        elif curl -s http://localhost:{{.GO_SERVER_PORT}}/health > /dev/null; then
          echo "âš¡ Testing Go server..."
          task test:quick:go
        else
          echo "âŒ No servers running. Start with 'task start' or 'task start:go'"
          exit 1
        fi

  quick:node:
    desc: "ğŸ§ª Quick load test against Node.js server"
    cmds:
      - |
        echo "ğŸ§ª Running quick load test against Node.js server..."
        WS_URL=ws://localhost:{{.NODE_SERVER_PORT}}/ws npm run load-test:quick

  quick:go:
    desc: "ğŸ§ª Quick load test against Go server"
    cmds:
      - |
        echo "ğŸ§ª Running quick load test against Go server..."
        WS_URL=ws://localhost:{{.GO_SERVER_PORT}}/ws npm run load-test:quick

  # Medium Tests
  medium:node:
    desc: "ğŸ§ª Medium load test (1000 connections) against Node.js server"
    cmds:
      - |
        echo "ğŸ§ª Running medium load test against Node.js server..."
        WS_URL=ws://localhost:{{.NODE_SERVER_PORT}}/ws npm run load-test:medium

  medium:go:
    desc: "ğŸ§ª Medium load test (1000 connections) against Go server"
    cmds:
      - |
        echo "ğŸ§ª Running medium load test against Go server..."
        WS_URL=ws://localhost:{{.GO_SERVER_PORT}}/ws npm run load-test:medium

  # Stress Tests
  stress:node:
    desc: "ğŸ§ª Stress test (5000 connections) against Node.js server"
    cmds:
      - |
        echo "ğŸ§ª Running stress test against Node.js server..."
        echo "âš ï¸  This may take several minutes and use significant resources"
        WS_URL=ws://localhost:{{.NODE_SERVER_PORT}}/ws npm run load-test:stress

  stress:go:
    desc: "ğŸ§ª Stress test (5000 connections) against Go server"
    cmds:
      - |
        echo "ğŸ§ª Running stress test against Go server..."
        echo "âš ï¸  This may take several minutes and use significant resources"
        WS_URL=ws://localhost:{{.GO_SERVER_PORT}}/ws npm run load-test:stress

  # Progressive Tests
  progressive:node:
    desc: "ğŸ§ª Progressive load test (100â†’1Kâ†’5K) against Node.js server"
    cmds:
      - |
        echo "ğŸ§ª Running progressive load test against Node.js server..."
        echo "âš ï¸  This will take 15+ minutes and use significant resources"
        WS_URL=ws://localhost:{{.NODE_SERVER_PORT}}/ws npm run load-test:progressive

  progressive:go:
    desc: "ğŸ§ª Progressive load test (100â†’1Kâ†’5K) against Go server"
    cmds:
      - |
        echo "ğŸ§ª Running progressive load test against Go server..."
        echo "âš ï¸  This will take 15+ minutes and use significant resources"
        WS_URL=ws://localhost:{{.GO_SERVER_PORT}}/ws npm run load-test:progressive

  # Comparison Tests
  compare:quick:
    desc: "ğŸ†š Quick performance comparison between Node.js and Go"
    cmds:
      - |
        echo "ğŸ†š Quick Performance Comparison"
        echo "==============================="
        timestamp=$(date +%Y%m%d_%H%M%S)
        mkdir -p {{.METRICS_DIR}}/comparison

        # Ensure both servers are running
        if ! curl -s http://localhost:{{.NODE_SERVER_PORT}}/health > /dev/null; then
          echo "âŒ Node.js server not running on port {{.NODE_SERVER_PORT}}"
          exit 1
        fi
        if ! curl -s http://localhost:{{.GO_SERVER_PORT}}/health > /dev/null; then
          echo "âŒ Go server not running on port {{.GO_SERVER_PORT}}"
          exit 1
        fi

        # Collect baseline metrics
        echo "ğŸ“Š Collecting baseline metrics..."
        task metrics:collect:all

        # Test Node.js
        echo ""
        echo "ğŸŸ¢ Testing Node.js Server..."
        echo "=============================="
        WS_URL=ws://localhost:{{.NODE_SERVER_PORT}}/ws npm run load-test:quick > {{.METRICS_DIR}}/comparison/node_quick_${timestamp}.log 2>&1
        task metrics:node:current > {{.METRICS_DIR}}/comparison/node_metrics_${timestamp}.txt

        # Wait between tests
        echo "â³ Waiting 30 seconds between tests..."
        sleep 30

        # Test Go
        echo ""
        echo "âš¡ Testing Go Server..."
        echo "======================"
        WS_URL=ws://localhost:{{.GO_SERVER_PORT}}/ws npm run load-test:quick > {{.METRICS_DIR}}/comparison/go_quick_${timestamp}.log 2>&1
        task metrics:go:current > {{.METRICS_DIR}}/comparison/go_metrics_${timestamp}.txt

        # Generate comparison report
        echo ""
        echo "ğŸ“‹ Generating Comparison Report..."
        task test:generate:comparison:report

  compare:stress:
    desc: "ğŸ†š Stress test comparison between Node.js and Go"
    cmds:
      - |
        echo "ğŸ†š Stress Test Comparison"
        echo "========================="
        echo "âš ï¸  This will take 20+ minutes and use significant resources"
        echo "ğŸ”„ Continue? (Ctrl+C to cancel, Enter to proceed)"
        read

        timestamp=$(date +%Y%m%d_%H%M%S)
        mkdir -p {{.METRICS_DIR}}/stress_comparison

        # Test Node.js stress
        echo ""
        echo "ğŸŸ¢ Node.js Stress Test..."
        WS_URL=ws://localhost:{{.NODE_SERVER_PORT}}/ws npm run load-test:stress > {{.METRICS_DIR}}/stress_comparison/node_stress_${timestamp}.log 2>&1

        # Wait between tests
        echo "â³ Waiting 2 minutes between tests..."
        sleep 120

        # Test Go stress
        echo ""
        echo "âš¡ Go Stress Test..."
        WS_URL=ws://localhost:{{.GO_SERVER_PORT}}/ws npm run load-test:stress > {{.METRICS_DIR}}/stress_comparison/go_stress_${timestamp}.log 2>&1

        echo "âœ… Stress comparison complete. Results in {{.METRICS_DIR}}/stress_comparison/"

  compare:performance:
    desc: "ğŸ†š Comprehensive performance comparison with metrics collection"
    cmds:
      - |
        echo "ğŸ†š Comprehensive Performance Comparison"
        echo "======================================="
        timestamp=$(date +%Y%m%d_%H%M%S)
        mkdir -p {{.METRICS_DIR}}/performance

        # Pre-test metrics
        echo "ğŸ“Š Collecting pre-test metrics..."
        task metrics:collect:all

        # Node.js tests
        echo ""
        echo "ğŸŸ¢ Node.js Performance Tests..."
        echo "================================"
        task test:quick:node > {{.METRICS_DIR}}/performance/node_quick_${timestamp}.log 2>&1
        task metrics:node:current > {{.METRICS_DIR}}/performance/node_post_quick_${timestamp}.txt

        sleep 30

        task test:medium:node > {{.METRICS_DIR}}/performance/node_medium_${timestamp}.log 2>&1
        task metrics:node:current > {{.METRICS_DIR}}/performance/node_post_medium_${timestamp}.txt

        # Wait between server tests
        echo "â³ Waiting 2 minutes between server tests..."
        sleep 120

        # Go tests
        echo ""
        echo "âš¡ Go Performance Tests..."
        echo "========================="
        task test:quick:go > {{.METRICS_DIR}}/performance/go_quick_${timestamp}.log 2>&1
        task metrics:go:current > {{.METRICS_DIR}}/performance/go_post_quick_${timestamp}.txt

        sleep 30

        task test:medium:go > {{.METRICS_DIR}}/performance/go_medium_${timestamp}.log 2>&1
        task metrics:go:current > {{.METRICS_DIR}}/performance/go_post_medium_${timestamp}.txt

        # Generate comprehensive report
        echo ""
        echo "ğŸ“‹ Generating comprehensive performance report..."
        task test:generate:performance:report

  # Connectivity Tests
  connectivity:
    desc: "ğŸ”— Test connectivity to all servers"
    cmds:
      - |
        echo "ğŸ”— Testing Connectivity"
        echo "======================="

        echo "NATS Server:"
        if curl -s http://localhost:4222 > /dev/null; then
          echo "  âœ… NATS reachable"
        else
          echo "  âŒ NATS not reachable"
        fi

        echo "Node.js Server:"
        if curl -s http://localhost:{{.NODE_SERVER_PORT}}/health > /dev/null; then
          echo "  âœ… Node.js server healthy"
        else
          echo "  âŒ Node.js server not healthy"
        fi

        echo "Go Server:"
        if curl -s http://localhost:{{.GO_SERVER_PORT}}/health > /dev/null; then
          echo "  âœ… Go server healthy"
        else
          echo "  âŒ Go server not healthy"
        fi

  # Report Generation
  generate:comparison:report:
    desc: "ğŸ“‹ Generate detailed comparison report from collected data"
    cmds:
      - |
        echo "ğŸ“‹ Performance Comparison Report"
        echo "================================"
        echo "Generated: $(date)"
        echo ""

        if [ -d "{{.METRICS_DIR}}/comparison" ]; then
          echo "ğŸ“ Analysis based on data in {{.METRICS_DIR}}/comparison/"
          echo ""

          # Find latest test files
          node_log=$(ls {{.METRICS_DIR}}/comparison/node_quick_*.log 2>/dev/null | tail -1)
          go_log=$(ls {{.METRICS_DIR}}/comparison/go_quick_*.log 2>/dev/null | tail -1)

          if [ -f "$node_log" ]; then
            echo "ğŸŸ¢ Node.js Results:"
            grep -E "(Total Attempted|Successful|Average Rate|Average.*ms)" "$node_log" | head -5
            echo ""
          fi

          if [ -f "$go_log" ]; then
            echo "âš¡ Go Results:"
            grep -E "(Total Attempted|Successful|Average Rate|Average.*ms)" "$go_log" | head -5
            echo ""
          fi

          echo "ğŸ’¡ Detailed logs available in {{.METRICS_DIR}}/comparison/"
        else
          echo "âš ï¸  No comparison data found. Run 'task test:compare:quick' first."
        fi

  generate:performance:report:
    desc: "ğŸ“‹ Generate comprehensive performance report"
    cmds:
      - |
        echo "ğŸ“‹ Comprehensive Performance Report"
        echo "==================================="
        echo "Generated: $(date)"
        echo ""

        if [ -d "{{.METRICS_DIR}}/performance" ]; then
          echo "ğŸ“ Analysis based on data in {{.METRICS_DIR}}/performance/"
          echo ""
          echo "ğŸ” Run 'ls {{.METRICS_DIR}}/performance/' to see all collected data"
          echo "ğŸ“Š Use 'task metrics:generate:report' for current live metrics"
        else
          echo "âš ï¸  No performance data found. Run 'task test:compare:performance' first."
        fi

  # Cleanup
  clean:
    desc: "ğŸ§¹ Clean up test results and metrics"
    cmds:
      - |
        echo "ğŸ§¹ Cleaning up test results..."
        rm -rf {{.METRICS_DIR}}/comparison {{.METRICS_DIR}}/performance {{.METRICS_DIR}}/stress_comparison
        echo "âœ… Test cleanup complete"