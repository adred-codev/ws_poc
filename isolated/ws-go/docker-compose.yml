# WebSocket Server - Isolated Setup
# Instance: odin-ws-go (dedicated e2-medium)
# Purpose: Handle WebSocket connections with full observability (logs + metrics)
#
# This compose file is templated. Before deployment, substitute:
#   ${BACKEND_INTERNAL_IP} - Internal IP of backend instance running NATS/Loki
#
# Example:
#   export BACKEND_INTERNAL_IP=10.128.0.2
#   envsubst < docker-compose.yml | docker compose -f - up -d

services:
  ws-go:
    build:
      context: ./src
      dockerfile: Dockerfile
    container_name: odin-ws-go
    ports:
      - "0.0.0.0:3004:3002"
    command:
      - "./odin-ws-server"
      - "-addr"
      - ":3002"
      - "-nats"
      - "nats://${BACKEND_INTERNAL_IP}:4222"
    environment:
      # Resource limits (e2-medium: 2 vCPU, 4GB RAM)
      # Allocation: 1.9 CPU, 3584M (leaves 0.1 CPU + 256M for Promtail)
      - WS_CPU_LIMIT=1.9
      - WS_MEMORY_LIMIT=3758096384 # 3584MB in bytes

      # Capacity: 18,000 connections
      - WS_MAX_CONNECTIONS=18000

      # Worker pool sizing
      # Formula: max(32, connections/40) = max(32, 18000/40) = 450 → 512 (power of 2)
      # Load per worker: (18000 × 20) / 512 = 703 items/sec
      - WS_WORKER_POOL_SIZE=512
      - WS_WORKER_QUEUE_SIZE=51200 # 100x workers

      # Rate limiting (safety valves)
      # Each NATS msg = 1 broadcast to ALL connections
      # At 18k conns: 20 msg/sec × 18k = 360k total writes/sec
      # Current real load: ~12 msg/sec (well below limit)
      - WS_MAX_NATS_RATE=1000
      - WS_MAX_BROADCAST_RATE=1000

      # Goroutine limit
      # Formula: ((18000 × 2) + 512 + 13) × 1.2 = 43,830
      # Rounded: 44,000
      - WS_MAX_GOROUTINES=44000

      # Safety thresholds
      - WS_CPU_REJECT_THRESHOLD=75.0
      - WS_CPU_PAUSE_THRESHOLD=80.0

      # Logging
      - LOG_LEVEL=info
      - LOG_FORMAT=json

    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.9"
          memory: 3584M
    ulimits:
      nofile:
        soft: 200000
        hard: 200000

  promtail:
    image: grafana/promtail:3.3.2
    container_name: odin-ws-promtail
    volumes:
      - ./promtail-config.yml:/etc/promtail/promtail-config.yml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/promtail-config.yml
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 256M
