# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: '3'

includes:
  test: ./tasks/test.yml

vars:
  NODE_SERVER_PORT: "3001"
  GO_SERVER_PORT: "3002"
  GO3_SERVER_PORT: "3005"
  PUBLISHER_PORT: "3003"
  NATS_PORT: "4222"
  NATS_MONITOR_PORT: "8222"

tasks:
  dev:
    desc: "ğŸš€ Start dev environment for go-server-2"
    cmds:
      - echo "ğŸ³ Starting dev stack (NATS + Go-2 + Publisher)..."
      - docker-compose up -d --build nats ws-go-2 publisher
      - echo "âœ… Dev stack ready!"
      - echo "  ğŸ”Œ WebSocket at ws://localhost:3004/ws"

  # Main entry points - containerized services
  start:
    desc: "ğŸš€ Start complete containerized stack (NATS + Node.js + Go + Publisher)"
    cmds:
      - echo "ğŸ³ Starting complete containerized stack..."
      - docker-compose up -d
      - sleep 10
      - echo "â–¶ï¸  Starting publisher with live price data..."
      - task: publisher:start
      - echo "âœ… All services ready!"
      - echo ""
      - echo "Services:"
      - echo "  ğŸ”Œ Node.js WebSocket at ws://localhost:3001/ws"
      - echo "  âš¡ Go WebSocket at ws://localhost:3002/ws (original)"
      - echo "  âš¡ Go-2 WebSocket at ws://localhost:3004/ws (optimized)"
      - echo "  ğŸš€ Go-3 WebSocket at ws://localhost:3005/ws (next-gen)"
      - echo "  ğŸ›ï¸  Publisher Control at http://localhost:3003/control"
      - echo "  ğŸ“Š NATS Monitor at http://localhost:8222"

  start:node:
    desc: "ğŸŸ¢ Start Node.js stack only (NATS + Node.js + Publisher)"
    cmds:
      - echo "ğŸ³ Starting Node.js stack..."
      - docker-compose up -d nats ws-node publisher
      - sleep 5
      # - echo "â–¶ï¸  Starting publisher with live price data..."
      # - task: publisher:start
      - echo "âœ… Node.js stack ready!"
      - echo "  ğŸ”Œ WebSocket at ws://localhost:3001/ws"

  start:go:
    desc: "âš¡ Start Go stack only (NATS + Go-2 + Publisher)"
    cmds:
      - echo "ğŸ³ Starting Go-2 stack..."
      - docker-compose up -d nats ws-go-2 publisher
      - sleep 5
      # - echo "â–¶ï¸  Starting publisher with live price data..."
      # - task: publisher:start
      - echo "âœ… Go-2 stack ready!"
      - echo "  ğŸ”Œ WebSocket at ws://localhost:3004/ws"

  start:go3:
    desc: "ğŸš€ Start Go-3 stack only (NATS + Go-3 + Publisher)"
    cmds:
      - echo "ğŸ³ Starting Go-3 stack..."
      - docker-compose up -d nats ws-go-3 publisher
      - sleep 5
      # - echo "â–¶ï¸  Starting publisher with live price data..."
      # - task: publisher:start
      - echo "âœ… Go-3 stack ready!"
      - echo "  ğŸš€ WebSocket at ws://localhost:3005/ws"

  # Publisher control
  publisher:start:
    desc: "â–¶ï¸  Start publisher stress test"
    cmds:
      - |
        curl -s -X POST http://localhost:3003/control \
          -H "Content-Type: application/json" \
          -d '{"action": "start", "messagesPerSecond": 50, "connections": 100}' \
          | jq .

  publisher:stop:
    desc: "â¹ï¸  Stop publisher"
    cmds:
      - |
        curl -s -X POST http://localhost:3003/control \
          -H "Content-Type: application/json" \
          -d '{"action": "stop"}' \
          | jq .

  publisher:stats:
    desc: "ğŸ“Š Show publisher statistics"
    cmds:
      - curl -s http://localhost:3003/stats | jq .

  # Health and status checks
  status:
    desc: "ğŸ“Š Check status of all services"
    cmds:
      - echo "ğŸ“Š Service Status Check"
      - echo "======================="
      - echo ""
      - echo "ğŸ³ Docker Containers:"
      - docker-compose ps
      - echo ""
      - echo "ğŸ¥ Health Checks:"
      - |
        if curl -s http://localhost:3001/health > /dev/null; then
          echo "  âœ… Node.js server healthy"
        else
          echo "  âŒ Node.js server not healthy"
        fi
      - |
        if curl -s http://localhost:3002/health > /dev/null; then
          echo "  âœ… Go server (original) healthy"
        else
          echo "  âŒ Go server (original) not healthy"
        fi
      - |
        if curl -s http://localhost:3004/health > /dev/null; then
          echo "  âœ… Go-2 server (optimized) healthy"
        else
          echo "  âŒ Go-2 server (optimized) not healthy"
        fi
      - |
        if curl -s http://localhost:3003/health > /dev/null; then
          echo "  âœ… Publisher healthy"
        else
          echo "  âŒ Publisher not healthy"
        fi

  logs:
    desc: "ğŸ“œ Show logs from all services"
    cmds:
      - docker-compose logs --tail=20

  logs:node:
    desc: "ğŸ“œ Show Node.js server logs"
    cmds:
      - docker-compose logs -f ws-node

  logs:go:
    desc: "ğŸ“œ Show Go server logs"
    cmds:
      - docker-compose logs -f ws-go-2

  logs:publisher:
    desc: "ğŸ“œ Show publisher logs"
    cmds:
      - docker-compose logs -f publisher

  # Build and rebuild
  build:
    desc: "ğŸ”¨ Build all containers"
    cmds:
      - echo "ğŸ”¨ Building all containers..."
      - docker-compose build
      - echo "âœ… All containers built"

  rebuild:
    desc: "ğŸ”„ Rebuild and restart all services"
    cmds:
      - echo "ğŸ”„ Rebuilding and restarting..."
      - task: stop
      - docker-compose build
      - task: start

  rebuild:node:
    desc: "ğŸ”„ Rebuild and restart Node.js service"
    cmds:
      - docker-compose stop ws-node
      - docker-compose build ws-node
      - docker-compose up -d ws-node

  rebuild:go:
    desc: "ğŸ”„ Rebuild and restart Go service"
    cmds:
      - docker-compose stop ws-go-2
      - docker-compose build ws-go-2
      - docker-compose up -d ws-go-2

  # Testing
  test:quick:
    desc: "ğŸ§ª Quick connectivity test"
    cmds:
      - task: test:connectivity

  test:stress:
    desc: "ğŸ§ª Run stress test using publisher control API"
    cmds:
      - echo "ğŸ§ª Starting 30-second stress test..."
      - task: publisher:start
      - sleep 30
      - task: publisher:stop
      - echo "ğŸ“Š Final stats:"
      - task: publisher:stats

  # WebSocket connection stress tests
  stress:go:
    desc: "ğŸ§ª Stress test Go WebSocket server with multiple connections"
    cmds:
      - echo "ğŸ§ª Stress testing Go server..."
      - node stress-test-go.cjs {{.CLI_ARGS | default "50 30"}}

  stress:node:
    desc: "ğŸ§ª Stress test Node.js WebSocket server with multiple connections"
    cmds:
      - echo "ğŸ§ª Stress testing Node.js server..."
      - node stress-test-node.cjs {{.CLI_ARGS | default "50 30"}}

  stress:both:
    desc: "ğŸ§ª Stress test both WebSocket servers simultaneously"
    cmds:
      - echo "ğŸ§ª Starting stress test on both servers..."
      - task: publisher:start
      - echo "Starting WebSocket clients..."
      - |
        (node stress-test-go.cjs {{.CLI_ARGS | default "25 30"}} &)
        (node stress-test-node.cjs {{.CLI_ARGS | default "25 30"}} &)
        wait
      - task: publisher:stop

  stress:only:
    desc: "ğŸš€ Launch stress test suite (assumes services already running)"
    cmds:
      - echo "ğŸš€ Launching stress test suite..."
      - echo "ğŸ“Š Running parallel stress tests ({{.CLI_ARGS | default "100 60"}})..."
      - |
        ARGS="{{.CLI_ARGS | default "100 60"}}"
        CONNECTIONS=$(echo $ARGS | cut -d' ' -f1)
        DURATION=$(echo $ARGS | cut -d' ' -f2)
        HALF_CONNECTIONS=$((CONNECTIONS / 2))

        echo "ğŸ¯ Test Configuration:"
        echo "  Total Connections: $CONNECTIONS ($HALF_CONNECTIONS per server)"
        echo "  Duration: ${DURATION}s"
        echo ""

        (node stress-test-node.cjs $HALF_CONNECTIONS $DURATION &)
        # (node stress-test-go.cjs $HALF_CONNECTIONS $DURATION &)
        # (node stress-test-high-load.cjs $HALF_CONNECTIONS $DURATION &)
        wait
      - echo ""
      - echo "âœ… Stress test completed!"

  stress:stop:
    desc: "ğŸ›‘ Stop running stress tests"
    cmds:
      - echo "ğŸ›‘ Stopping stress tests..."
      - |
        echo "Killing Node.js stress test processes..."
        pkill -f "stress-test" || echo "No stress test processes found"
        echo "âœ… Stress tests stopped"

  stress:container:
    desc: "ğŸ§ª Container-optimized stress test for Go-2 server (512MB/2CPU limits)"
    cmds:
      - echo "ğŸ§ª Running Go-2 container-optimized stress test..."
      - |
        echo "ğŸ¯ Container Test Configuration:"
        echo "  Go Server 2: Targeting 5000 connections (512MB limit)"
        echo "  Duration: 60 seconds"
        echo ""
        echo "ğŸ”¥ Testing Go server 2 (container optimized - port 3004)..."
        node stress-test-high-load.cjs 5000 60 go2
      - echo ""
      - echo "âœ… Container stress test completed!"

  test:connection-rate:
    desc: "ğŸ§ª Test Go-2 server connection success rate (target: 90%+)"
    cmds:
      - echo "ğŸ§ª Testing Go-2 server connection rate..."
      - |
        echo "ğŸ¯ Connection Rate Test:"
        echo "  Target: 90%+ success rate"
        echo "  Go-2 server: 3000 connections"
        echo ""
        node test-connection-rate.cjs ws://localhost:3004/ws 3000
      - echo ""
      - echo "âœ… Connection rate test completed!"

  # Cleanup
  stop:
    desc: "ğŸ›‘ Stop all services"
    cmds:
      - echo "ğŸ›‘ Stopping all services..."
      - docker-compose down
      - echo "âœ… All services stopped"

  clean:
    desc: "ğŸ§¹ Clean up everything (containers, images, volumes)"
    cmds:
      - echo "ğŸ§¹ Cleaning up..."
      - docker-compose down -v --remove-orphans
      - docker system prune -f --volumes
      - echo "âœ… Cleanup complete"

  # Development helpers
  shell:node:
    desc: "ğŸš Open shell in Node.js container"
    cmds:
      - docker-compose exec ws-node sh

  shell:go:
    desc: "ğŸš Open shell in Go container"
    cmds:
      - docker-compose exec ws-go-2 sh

  # Help
  default:
    desc: "ğŸ  Show main commands"
    cmds:
      - task: help

  help:
    desc: "ğŸ“– Show available commands"
    silent: true
    cmds:
      - echo "ğŸš€ WebSocket Performance Testing Stack"
      - echo "======================================"
      - echo ""
      - echo "ğŸ“¦ Main Commands:"
      - echo "  task start          - Start complete stack (recommended)"
      - echo "  task start:node     - Start Node.js stack only"
      - echo "  task start:go       - Start Go stack only"
      - echo "  task stop           - Stop all services"
      - echo ""
      - echo "ğŸ§ª Testing:"
      - echo "  task test:quick     - Quick connectivity test"
      - echo "  task test:stress    - Stress test with publisher"
      - echo "  task test:compare   - Compare Node.js vs Go performance"
      - echo ""
      - echo "ğŸ“Š Monitoring:"
      - echo "  task status         - Check all services"
      - echo "  task logs           - View all logs"
      - echo "  task publisher:stats - Publisher metrics"
      - echo ""
      - echo "ğŸ› ï¸  Development:"
      - echo "  task build          - Build all containers"
      - echo "  task rebuild        - Rebuild and restart"
      - echo "  task clean          - Clean up everything"
      - echo ""
      - echo "ğŸ”— URLs (after starting):"
      - echo "  Node.js WS at ws://localhost:3001/ws"
      - echo "  Go WS (original) at ws://localhost:3002/ws"
      - echo "  Go-2 WS (optimized) at ws://localhost:3004/ws"
      - echo "  Publisher API at http://localhost:3003"
      - echo "  NATS Monitor at http://localhost:8222"