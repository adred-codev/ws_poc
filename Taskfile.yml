version: '3'

includes:
  test: ./tasks/test.yml

vars:
  NODE_SERVER_PORT: "3001"
  GO_SERVER_PORT: "3002"
  PUBLISHER_PORT: "3003"
  NATS_PORT: "4222"
  NATS_MONITOR_PORT: "8222"

tasks:
  # Main entry points - containerized services
  start:
    desc: "ğŸš€ Start complete containerized stack (NATS + Node.js + Go + Publisher)"
    cmds:
      - echo "ğŸ³ Starting complete containerized stack..."
      - docker-compose up -d
      - sleep 10
      - echo "âœ… All services ready!"
      - echo ""
      - echo "Services:"
      - echo "  ğŸ”Œ Node.js WebSocket at ws://localhost:3001/ws"
      - echo "  âš¡ Go WebSocket at ws://localhost:3002/ws"
      - echo "  ğŸ›ï¸  Publisher Control at http://localhost:3003/control"
      - echo "  ğŸ“Š NATS Monitor at http://localhost:8222"

  start:node:
    desc: "ğŸŸ¢ Start Node.js stack only (NATS + Node.js + Publisher)"
    cmds:
      - echo "ğŸ³ Starting Node.js stack..."
      - docker-compose up -d nats ws-node publisher
      - sleep 5
      - echo "âœ… Node.js stack ready!"
      - echo "  ğŸ”Œ WebSocket at ws://localhost:3001/ws"

  start:go:
    desc: "âš¡ Start Go stack only (NATS + Go + Publisher)"
    cmds:
      - echo "ğŸ³ Starting Go stack..."
      - docker-compose up -d nats ws-go publisher
      - sleep 5
      - echo "âœ… Go stack ready!"
      - echo "  ğŸ”Œ WebSocket at ws://localhost:3002/ws"

  # Publisher control
  publisher:start:
    desc: "â–¶ï¸  Start publisher stress test"
    cmds:
      - |
        curl -s -X POST http://localhost:3003/control \
          -H "Content-Type: application/json" \
          -d '{"action": "start", "messagesPerSecond": 50, "connections": 100}' \
          | jq .

  publisher:stop:
    desc: "â¹ï¸  Stop publisher"
    cmds:
      - |
        curl -s -X POST http://localhost:3003/control \
          -H "Content-Type: application/json" \
          -d '{"action": "stop"}' \
          | jq .

  publisher:stats:
    desc: "ğŸ“Š Show publisher statistics"
    cmds:
      - curl -s http://localhost:3003/stats | jq .

  # Health and status checks
  status:
    desc: "ğŸ“Š Check status of all services"
    cmds:
      - echo "ğŸ“Š Service Status Check"
      - echo "======================="
      - echo ""
      - echo "ğŸ³ Docker Containers:"
      - docker-compose ps
      - echo ""
      - echo "ğŸ¥ Health Checks:"
      - |
        if curl -s http://localhost:3001/health > /dev/null; then
          echo "  âœ… Node.js server healthy"
        else
          echo "  âŒ Node.js server not healthy"
        fi
      - |
        if curl -s http://localhost:3002/health > /dev/null; then
          echo "  âœ… Go server healthy"
        else
          echo "  âŒ Go server not healthy"
        fi
      - |
        if curl -s http://localhost:3003/health > /dev/null; then
          echo "  âœ… Publisher healthy"
        else
          echo "  âŒ Publisher not healthy"
        fi

  logs:
    desc: "ğŸ“œ Show logs from all services"
    cmds:
      - docker-compose logs --tail=20

  logs:node:
    desc: "ğŸ“œ Show Node.js server logs"
    cmds:
      - docker-compose logs -f ws-node

  logs:go:
    desc: "ğŸ“œ Show Go server logs"
    cmds:
      - docker-compose logs -f ws-go

  logs:publisher:
    desc: "ğŸ“œ Show publisher logs"
    cmds:
      - docker-compose logs -f publisher

  # Build and rebuild
  build:
    desc: "ğŸ”¨ Build all containers"
    cmds:
      - echo "ğŸ”¨ Building all containers..."
      - docker-compose build
      - echo "âœ… All containers built"

  rebuild:
    desc: "ğŸ”„ Rebuild and restart all services"
    cmds:
      - echo "ğŸ”„ Rebuilding and restarting..."
      - task: stop
      - docker-compose build
      - task: start

  rebuild:node:
    desc: "ğŸ”„ Rebuild and restart Node.js service"
    cmds:
      - docker-compose stop ws-node
      - docker-compose build ws-node
      - docker-compose up -d ws-node

  rebuild:go:
    desc: "ğŸ”„ Rebuild and restart Go service"
    cmds:
      - docker-compose stop ws-go
      - docker-compose build ws-go
      - docker-compose up -d ws-go

  # Testing
  test:quick:
    desc: "ğŸ§ª Quick connectivity test"
    cmds:
      - task: test:connectivity

  test:stress:
    desc: "ğŸ§ª Run stress test using publisher control API"
    cmds:
      - echo "ğŸ§ª Starting 30-second stress test..."
      - task: publisher:start
      - sleep 30
      - task: publisher:stop
      - echo "ğŸ“Š Final stats:"
      - task: publisher:stats

  # Cleanup
  stop:
    desc: "ğŸ›‘ Stop all services"
    cmds:
      - echo "ğŸ›‘ Stopping all services..."
      - docker-compose down
      - echo "âœ… All services stopped"

  clean:
    desc: "ğŸ§¹ Clean up everything (containers, images, volumes)"
    cmds:
      - echo "ğŸ§¹ Cleaning up..."
      - docker-compose down -v --remove-orphans
      - docker system prune -f --volumes
      - echo "âœ… Cleanup complete"

  # Development helpers
  shell:node:
    desc: "ğŸš Open shell in Node.js container"
    cmds:
      - docker-compose exec ws-node sh

  shell:go:
    desc: "ğŸš Open shell in Go container"
    cmds:
      - docker-compose exec ws-go sh

  # Help
  default:
    desc: "ğŸ  Show main commands"
    cmds:
      - task: help

  help:
    desc: "ğŸ“– Show available commands"
    silent: true
    cmds:
      - echo "ğŸš€ WebSocket Performance Testing Stack"
      - echo "======================================"
      - echo ""
      - echo "ğŸ“¦ Main Commands:"
      - echo "  task start          - Start complete stack (recommended)"
      - echo "  task start:node     - Start Node.js stack only"
      - echo "  task start:go       - Start Go stack only"
      - echo "  task stop           - Stop all services"
      - echo ""
      - echo "ğŸ§ª Testing:"
      - echo "  task test:quick     - Quick connectivity test"
      - echo "  task test:stress    - Stress test with publisher"
      - echo "  task test:compare   - Compare Node.js vs Go performance"
      - echo ""
      - echo "ğŸ“Š Monitoring:"
      - echo "  task status         - Check all services"
      - echo "  task logs           - View all logs"
      - echo "  task publisher:stats - Publisher metrics"
      - echo ""
      - echo "ğŸ› ï¸  Development:"
      - echo "  task build          - Build all containers"
      - echo "  task rebuild        - Rebuild and restart"
      - echo "  task clean          - Clean up everything"
      - echo ""
      - echo "ğŸ”— URLs (after starting):"
      - echo "  Node.js WS at ws://localhost:3001/ws"
      - echo "  Go WS at ws://localhost:3002/ws"
      - echo "  Publisher API at http://localhost:3003"
      - echo "  NATS Monitor at http://localhost:8222"