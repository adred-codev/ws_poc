version: "3"

# Main Taskfile - Orchestrates all sub-taskfiles
# Run 'task' or 'task --list' to see available commands

dotenv: ["./deployments/v1/gcp/.env.gcp"]

includes:
  # Version management
  version:
    taskfile: ./taskfiles/version.yml
    dir: .

  # Local deployment (Kafka/Redpanda) - v1 (TEMPORARILY DISABLED)
  # local:
  #   taskfile: ./taskfiles/v1/local/services.yml
  #   dir: .
  # local:health:
  #   taskfile: ./taskfiles/v1/local/health.yml
  #   dir: .
  # local:deploy:
  #   taskfile: ./taskfiles/v1/local/deployment.yml
  #   dir: .
  # local:test:
  #   taskfile: ./taskfiles/v1/local/load-test.yml
  #   dir: .
  # local:stats:
  #   taskfile: ./taskfiles/v1/local/stats.yml
  #   dir: .

  # GCP deployment (Kafka/Redpanda, Distributed) - v1
  gcp:
    taskfile: ./taskfiles/v1/gcp/Taskfile.yml
    dir: .

tasks:
  default:
    desc: Show available commands
    silent: true
    cmds:
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo "ğŸ“‹ ODIN WEBSOCKET SERVER - TASK COMMANDS"
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo ""
      - echo "ğŸ“¦ VERSION MANAGEMENT"
      - echo "  task version:info              - Show current version"
      - echo "  task version:check             - Validate version consistency"
      - echo "  task version:build:images      - Build Docker images"
      - echo "  task version:help              - Version management help"
      - echo ""
      - echo "ğŸ  LOCAL DEPLOYMENT"
      - echo "  task up                        - Quick start deployment"
      - echo "  task down                      - Quick stop deployment"
      - echo "  task health                    - Quick health check"
      - echo "  task test                      - Quick load test"
      - echo ""
      - echo "ğŸ“¦ DEPLOYMENT WORKFLOWS"
      - echo "  task local:deploy:setup        - Complete setup from scratch"
      - echo "  task local:deploy:reset        - Delete all & redeploy"
      - echo "  task local:deploy:quick-start  - Quick start (assumes setup)"
      - echo "  task local:deploy:stop         - Stop all services"
      - echo "  task local:deploy:rebuild-code - Rebuild after code changes"
      - echo ""
      - echo "ğŸ”§ SERVICE CONTROL (Individual)"
      - echo "  task local:start:redpanda      - Start Redpanda"
      - echo "  task local:start:publisher     - Start Publisher"
      - echo "  task local:start:ws            - Start WS server"
      - echo "  task local:restart:ws          - Restart WS server"
      - echo "  task local:rebuild:ws          - Rebuild WS server"
      - echo "  task local:logs:ws             - Tail WS server logs"
      - echo ""
      - echo "ğŸ”§ SERVICE CONTROL (Aggregate)"
      - echo "  task local:start:all           - Start all services"
      - echo "  task local:delete:all          - Delete all (nuclear)"
      - echo "  task local:restart:all         - Restart all services"
      - echo "  task local:rebuild:all         - Rebuild all services"
      - echo "  task local:logs:all            - Tail all logs"
      - echo "  task local:status              - Show service status"
      - echo ""
      - echo "ğŸ¥ HEALTH CHECKS"
      - echo "  task local:health:all          - Check all services"
      - echo "  task local:health:detailed     - Detailed health (JSON)"
      - echo "  task local:health:redpanda     - Check Redpanda only"
      - echo "  task local:health:publisher    - Check Publisher only"
      - echo "  task local:health:ws           - Check WS server only"
      - echo ""
      - echo "ğŸ§ª LOAD TESTING"
      - echo "  task local:test:sustained      - Sustained capacity test"
      - echo "  task local:test:stop           - Stop load test"
      - echo "  task local:test:status         - Check test status"
      - echo ""
      - echo "ğŸ“Š STATS & MONITORING"
      - echo "  task local:stats:all           - Show all stats"
      - echo "  task local:stats:publisher     - Publisher stats"
      - echo "  task local:stats:ws            - WS server stats"
      - echo "  task local:stats:ips           - Container IP addresses"
      - echo "  task local:stats:topics        - List Kafka topics"
      - echo "  task local:stats:consume       - Consume messages (TOPIC=... NUM=...)"
      - echo ""
      - echo "â˜ï¸  GCP DEPLOYMENT (TOP-LEVEL SHORTCUTS)"
      - echo "  task gcp:deploy                     - Complete first-time deployment"
      - echo "  task gcp:up                         - Start all GCP services (quick start)"
      - echo "  task gcp:down                       - Stop all GCP services"
      - echo "  task gcp:restart                    - Restart all GCP services"
      - echo "  task gcp:status                     - Show deployment status"
      - echo "  task gcp:verify                     - Verify health"
      - echo ""
      - echo "â˜ï¸  GCP DEPLOYMENT WORKFLOWS"
      - echo "  task gcp:deployment:setup           - Complete setup (infra + app)"
      - echo "  task gcp:deployment:infrastructure  - Setup infrastructure only"
      - echo "  task gcp:deployment:guided-setup    - Guided app setup (manual steps)"
      - echo "  task gcp:deployment:quick-start     - Quick start (daily use)"
      - echo "  task gcp:deployment:stop            - Stop all services"
      - echo "  task gcp:deployment:reset           - Reset deployment"
      - echo "  task gcp:deployment:rebuild-code    - Rebuild after code changes"
      - echo "  task gcp:deployment:show-urls       - Show service URLs"
      - echo ""
      - echo "â˜ï¸  GCP CODE REBUILDS"
      - echo "  task gcp:deployment:rebuild:backend - Rebuild backend with latest code"
      - echo "  task gcp:deployment:rebuild:ws      - Rebuild WS server with latest code"
      - echo "  task gcp:deployment:rebuild:all     - Rebuild all services"
      - echo ""
      - echo "â˜ï¸  GCP SERVICE CONTROL"
      - echo "  task gcp:services:start:backend     - Start backend services"
      - echo "  task gcp:services:start:ws          - Start WebSocket server"
      - echo "  task gcp:services:stop:all          - Stop all services"
      - echo "  task gcp:services:restart:all       - Restart all services"
      - echo "  task gcp:services:ps                - Show running containers"
      - echo "  task gcp:services:logs:backend      - View backend logs (follow)"
      - echo "  task gcp:services:logs:ws           - View WS logs (follow)"
      - echo ""
      - echo "â˜ï¸  GCP HEALTH & MONITORING"
      - echo "  task gcp:health:all                 - Check all services health"
      - echo "  task gcp:stats:urls                 - Show service URLs"
      - echo "  task gcp:load-test:capacity         - Run capacity test (12K)"
      - echo ""
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo ""
      - echo "ğŸ’¡ TIP - Run task --list-all to see all available tasks"
      - echo "ğŸ’¡ TIP - Run task TASKNAME --summary for task description"
      - echo "ğŸ’¡ TIP - See GCP_CONSOLIDATION_PLAN.md for GCP deployment guide"
      - echo ""

  # ============================================================================
  # QUICK SHORTCUTS
  # ============================================================================

  up:
    desc: Quick start local deployment
    cmds:
      - task: local:deploy:quick-start

  down:
    desc: Stop local deployment
    cmds:
      - task: local:deploy:stop

  restart:
    desc: Restart all local services
    cmds:
      - task: local:restart:all

  status:
    desc: Show local deployment status
    cmds:
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo "ğŸ“Š LOCAL DEPLOYMENT STATUS"
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo ""
      - task: local:health:all
      - echo ""
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo ""
      - task: local:deploy:show-urls
      - echo ""
      - task: local:status

  verify:
    desc: Verify local deployment health
    cmds:
      - task: local:health:all

  deploy:
    desc: Complete local deployment from scratch
    cmds:
      - task: local:deploy:setup

  health:
    desc: Quick health check
    cmds:
      - task: local:health:all

  test:
    desc: Quick sustained load test
    cmds:
      - task: local:test:sustained

  stats:
    desc: Quick stats overview
    cmds:
      - task: local:stats:all
