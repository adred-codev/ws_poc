version: "3"

# Version Management Tasks
# Manage versions, build images, and handle version-related operations

vars:
  VERSION_FILE: ./VERSION
  METADATA_FILE: ./.version-metadata.yml
  WS_VERSION_FILE: ./ws/VERSION
  CURRENT_VERSION:
    sh: test -f {{.VERSION_FILE}} && grep "^version:" {{.VERSION_FILE}} | cut -d' ' -f2 || echo "unknown"

tasks:
  info:
    desc: Show current version information
    cmds:
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo "ğŸ“¦ CURRENT VERSION INFORMATION"
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo ""
      - echo "Root Version - {{.CURRENT_VERSION}}"
      - echo ""
      - |
        WS_VER=$(grep "^version:" {{.WS_VERSION_FILE}} | cut -d' ' -f2)
        PUB_VER=$(jq -r '.version' publisher/package.json)
        echo "Components:"
        echo "  ws-server:  $WS_VER"
        echo "  publisher:  v$PUB_VER"
      - echo ""
      - |
        echo "Active Deployment:"
        CURRENT=$(readlink deployments/current)
        echo "  deployments/current â†’ $CURRENT"
        CURRENT_TASK=$(readlink taskfiles/current)
        echo "  taskfiles/current   â†’ $CURRENT_TASK"
      - echo ""
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  check:
    desc: Validate version consistency across all components
    cmds:
      - echo "ğŸ” Checking version consistency..."
      - echo ""
      - |
        ROOT_VER={{.CURRENT_VERSION}}
        WS_VER=$(grep "^version:" {{.WS_VERSION_FILE}} | cut -d' ' -f2)
        PUB_VER="v$(jq -r '.version' publisher/package.json)"
        ROOT_WS=$(grep "^  ws-server:" {{.VERSION_FILE}} | awk '{print $2}')
        ROOT_PUB=$(grep "^  publisher:" {{.VERSION_FILE}} | head -1 | awk '{print $2}')

        echo "VERSION file:"
        echo "  Root:       $ROOT_VER"
        echo "  ws-server:  $ROOT_WS"
        echo "  publisher:  $ROOT_PUB"
        echo ""
        echo "Component VERSION files:"
        echo "  ws/VERSION:          $WS_VER"
        echo "  publisher/package:   $PUB_VER"
        echo ""

        ERRORS=0
        if [ "$WS_VER" != "$ROOT_WS" ]; then
          echo "âŒ ws-server version mismatch!"
          ERRORS=1
        fi
        if [ "$PUB_VER" != "$ROOT_PUB" ]; then
          echo "âŒ publisher version mismatch!"
          ERRORS=1
        fi

        if [ $ERRORS -eq 0 ]; then
          echo "âœ… All versions are consistent"
        else
          exit 1
        fi

  list:
    desc: List all available versions
    cmds:
      - echo "ğŸ“‹ Available Versions:"
      - echo ""
      - |
        if [ -d deployments/v1 ]; then
          echo "  v1/ - $(grep 'description:' deployments/v1/VERSION | cut -d'|' -f2 | xargs)"
        fi
        if [ -d deployments/v2 ]; then
          echo "  v2/ - $(grep 'description:' deployments/v2/VERSION | cut -d'|' -f2 | xargs)"
        fi
      - echo ""
      - |
        CURRENT=$(readlink deployments/current)
        echo "Current: $CURRENT"

  switch:
    desc: Switch to a different version (e.g., task version:switch -- v2)
    cmds:
      - |
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "âŒ Please specify version: task version:switch -- v2"
          exit 1
        fi
        VERSION={{.CLI_ARGS}}
        if [ ! -d "deployments/$VERSION" ]; then
          echo "âŒ Version $VERSION does not exist"
          exit 1
        fi
        echo "ğŸ”„ Switching to $VERSION..."
        rm -f deployments/current taskfiles/current
        ln -sf $VERSION deployments/current
        ln -sf $VERSION taskfiles/current
        echo "âœ… Switched to $VERSION"
        task version:info

  build:images:
    desc: Build Docker images for current version with multi-tags
    cmds:
      - echo "ğŸ”¨ Building Docker images for {{.CURRENT_VERSION}}..."
      - task: _build_ws_image
      - task: _build_publisher_image
      - echo ""
      - echo "âœ… All images built successfully"

  _build_ws_image:
    internal: true
    cmds:
      - |
        VERSION={{.CURRENT_VERSION}}
        MAJOR=$(echo $VERSION | cut -d. -f1)
        MINOR=$(echo $VERSION | cut -d. -f1-2)

        echo ""
        echo "Building ws-server..."
        cd ws
        docker build -t odin-ws-server:$VERSION . --quiet
        docker tag odin-ws-server:$VERSION odin-ws-server:$MINOR
        docker tag odin-ws-server:$VERSION odin-ws-server:$MAJOR
        docker tag odin-ws-server:$VERSION odin-ws-server:latest

        echo "  âœ… odin-ws-server:$VERSION"
        echo "     Tagged: $MINOR, $MAJOR, latest"

  _build_publisher_image:
    internal: true
    cmds:
      - |
        VERSION=$(jq -r '.version' publisher/package.json)
        MAJOR=$(echo v$VERSION | cut -d. -f1)
        MINOR=$(echo v$VERSION | cut -d. -f1-2)

        echo ""
        echo "Building publisher..."
        cd publisher
        docker build -t odin-publisher:v$VERSION . --quiet
        docker tag odin-publisher:v$VERSION odin-publisher:$MINOR
        docker tag odin-publisher:v$VERSION odin-publisher:$MAJOR
        docker tag odin-publisher:v$VERSION odin-publisher:latest

        echo "  âœ… odin-publisher:v$VERSION"
        echo "     Tagged: $MINOR, $MAJOR, latest"

  images:list:
    desc: List all built Docker images
    cmds:
      - echo "ğŸ³ Docker Images:"
      - echo ""
      - docker images | grep -E "odin-ws-server|odin-publisher|REPOSITORY"

  images:clean:
    desc: Remove old Docker images (keeps latest)
    prompt: This will remove old image versions. Continue?
    cmds:
      - |
        echo "ğŸ§¹ Cleaning old images..."
        docker images | grep odin-ws-server | grep -v latest | awk '{print $3}' | xargs -r docker rmi 2>/dev/null || true
        docker images | grep odin-publisher | grep -v latest | awk '{print $3}' | xargs -r docker rmi 2>/dev/null || true
        echo "âœ… Cleanup complete"

  tag:create:
    desc: Create git tag for current version
    cmds:
      - |
        VERSION={{.CURRENT_VERSION}}
        echo "Creating git tag: $VERSION"

        if git rev-parse "$VERSION" >/dev/null 2>&1; then
          echo "âŒ Tag $VERSION already exists"
          exit 1
        fi

        git tag -a $VERSION -m "Release $VERSION"
        echo "âœ… Tag created: $VERSION"
        echo ""
        echo "Push with: git push origin $VERSION"

  tag:list:
    desc: List all git tags
    cmds:
      - echo "ğŸ·ï¸  Git Tags:"
      - git tag -l -n1

  changelog:view:
    desc: View changelog
    cmds:
      - cat CHANGELOG.md

  changelog:edit:
    desc: Edit changelog
    cmds:
      - ${EDITOR:-vim} CHANGELOG.md

  validate:config:
    desc: Validate docker-compose configurations
    cmds:
      - echo "âœ“ Validating configurations..."
      - |
        CURRENT=$(readlink deployments/current)
        echo ""
        echo "Checking $CURRENT/local/docker-compose.yml..."
        cd deployments/$CURRENT/local
        docker-compose config > /dev/null && echo "  âœ… Local config valid"
      - |
        CURRENT=$(readlink deployments/current)
        echo ""
        echo "Checking $CURRENT/gcp/distributed/ws-server/docker-compose.yml..."
        cd deployments/$CURRENT/gcp/distributed/ws-server
        docker-compose config > /dev/null && echo "  âœ… GCP config valid"
      - echo ""
      - echo "âœ… All configurations valid"

  deploy:local:
    desc: Deploy specific version locally (e.g., task version:deploy:local -- v1)
    cmds:
      - |
        if [ -z "{{.CLI_ARGS}}" ]; then
          CURRENT=$(readlink deployments/current)
          VERSION=$CURRENT
          echo "Using current version: $VERSION"
        else
          VERSION={{.CLI_ARGS}}
        fi

        if [ ! -d "deployments/$VERSION" ]; then
          echo "âŒ Version $VERSION does not exist"
          exit 1
        fi

        echo "ğŸš€ Deploying $VERSION locally..."
        cd deployments/$VERSION/local
        docker-compose up -d
        echo "âœ… Deployed $VERSION"

  status:
    desc: Show version and deployment status
    cmds:
      - task: info
      - echo ""
      - echo "ğŸ³ Running Containers:"
      - docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "odin-|redpanda|NAMES"

  help:
    desc: Show version management help
    cmds:
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo "ğŸ“¦ VERSION MANAGEMENT COMMANDS"
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo ""
      - echo "Information:"
      - echo "  task version:info              - Show current version"
      - echo "  task version:check             - Validate consistency"
      - echo "  task version:list              - List available versions"
      - echo "  task version:status            - Version + deployment status"
      - echo ""
      - echo "Version Switching:"
      - echo "  task version:switch -- v2      - Switch to version v2"
      - echo "  task version:deploy:local -- v1 - Deploy v1 locally"
      - echo ""
      - echo "Docker Images:"
      - echo "  task version:build:images      - Build images with multi-tags"
      - echo "  task version:images:list       - List built images"
      - echo "  task version:images:clean      - Clean old images"
      - echo ""
      - echo "Git Operations:"
      - echo "  task version:tag:create        - Create git tag"
      - echo "  task version:tag:list          - List git tags"
      - echo ""
      - echo "Documentation:"
      - echo "  task version:changelog:view    - View changelog"
      - echo "  task version:changelog:edit    - Edit changelog"
      - echo ""
      - echo "Validation:"
      - echo "  task version:validate:config   - Validate docker-compose files"
      - echo ""
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
