version: "3"

# =============================================================================
# GCP Service Management Tasks
# =============================================================================
# Purpose: Start, stop, restart services on GCP instances
# Scope: Docker Compose operations on remote instances

tasks:
  # === BACKEND SERVICES ===

  start:backend:
    desc: Start all backend services (Redpanda, Publisher, Monitoring)
    cmds:
      - echo "üöÄ Starting backend services on {{.BACKEND_INSTANCE}}..."
      - |
        gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --command="\
          sudo -i -u deploy bash -c 'cd /home/deploy/ws_poc/deployments/v1/gcp/distributed/backend && docker-compose up -d'"
      - echo "‚è≥ Waiting for services to be ready..."
      - sleep 15
      - task: :health:backend
      - echo "‚úÖ Backend services started"

  stop:backend:
    desc: Stop all backend services
    cmds:
      - echo "‚è∏Ô∏è  Stopping backend services on {{.BACKEND_INSTANCE}}..."
      - |
        gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --command="\
          sudo -i -u deploy bash -c 'cd /home/deploy/ws_poc/deployments/v1/gcp/distributed/backend && docker-compose down'"
      - echo "‚úÖ Backend services stopped"

  restart:backend:
    desc: Restart all backend services
    cmds:
      - echo "üîÑ Restarting backend services on {{.BACKEND_INSTANCE}}..."
      - |
        gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --command="\
          sudo -i -u deploy bash -c 'cd /home/deploy/ws_poc/deployments/v1/gcp/distributed/backend && docker-compose restart'"
      - echo "‚è≥ Waiting for services to be ready..."
      - sleep 15
      - task: :health:backend
      - echo "‚úÖ Backend services restarted"

  # === WEBSOCKET SERVER ===

  start:ws:
    desc: "Start WebSocket server (mode-aware: reads WS_MODE from .env.production)"
    cmds:
      - echo "üöÄ Starting WebSocket server on {{.WS_INSTANCE}}..."
      - |
        # Get backend internal IP
        BACKEND_IP=$(gcloud compute instances describe {{.BACKEND_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --format="get(networkInterfaces[0].networkIP)")

        echo "Backend Internal IP: $BACKEND_IP"

        gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} --command="\
          sudo -i -u deploy bash -c '\
            cd /home/deploy/ws_poc/deployments/v1/gcp/distributed/ws-server && \
            source .env.production && \
            export BACKEND_INTERNAL_IP=$BACKEND_IP && \
            COMPOSE_FILE=\$([ \"\$WS_MODE\" = \"multi\" ] && echo \"docker-compose.multi.yml\" || echo \"docker-compose.yml\") && \
            echo \"Mode: \$WS_MODE, Using: \$COMPOSE_FILE\" && \
            docker-compose -f \$COMPOSE_FILE up -d'"
      - echo "‚è≥ Waiting for WebSocket server to be ready..."
      - sleep 10
      - task: :health:ws
      - echo "‚úÖ WebSocket server started"

  stop:ws:
    desc: Stop WebSocket server (mode-aware)
    cmds:
      - echo "‚è∏Ô∏è  Stopping WebSocket server on {{.WS_INSTANCE}}..."
      - |
        gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} --command="\
          sudo -i -u deploy bash -c '\
            cd /home/deploy/ws_poc/deployments/v1/gcp/distributed/ws-server && \
            source .env.production && \
            COMPOSE_FILE=\$([ \"\$WS_MODE\" = \"multi\" ] && echo \"docker-compose.multi.yml\" || echo \"docker-compose.yml\") && \
            docker-compose -f \$COMPOSE_FILE down'"
      - echo "‚úÖ WebSocket server stopped"

  restart:ws:
    desc: Restart WebSocket server (mode-aware)
    cmds:
      - echo "üîÑ Restarting WebSocket server on {{.WS_INSTANCE}}..."
      - |
        gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} --command="\
          sudo -i -u deploy bash -c '\
            cd /home/deploy/ws_poc/deployments/v1/gcp/distributed/ws-server && \
            source .env.production && \
            COMPOSE_FILE=\$([ \"\$WS_MODE\" = \"multi\" ] && echo \"docker-compose.multi.yml\" || echo \"docker-compose.yml\") && \
            docker-compose -f \$COMPOSE_FILE restart'"
      - echo "‚è≥ Waiting for WebSocket server to be ready..."
      - sleep 10
      - task: :health:ws
      - echo "‚úÖ WebSocket server restarted"

  # === ALL SERVICES ===

  start:all:
    desc: Start all services (backend + WebSocket server)
    cmds:
      - task: start:backend
      - task: start:ws
      - echo ""
      - echo "‚úÖ All services started"
      - task: :stats:urls

  stop:all:
    desc: Stop all services (backend + WebSocket server)
    cmds:
      - task: stop:ws
      - task: stop:backend
      - echo ""
      - echo "‚úÖ All services stopped"

  restart:all:
    desc: Restart all services (backend + WebSocket server)
    cmds:
      - task: restart:backend
      - task: restart:ws
      - echo ""
      - echo "‚úÖ All services restarted"
      - task: :stats:urls

  # === STATUS ===

  ps:
    desc: Show running containers on all instances
    cmds:
      - task: ps:all

  ps:backend:
    desc: Show running containers on backend instance
    cmds:
      - echo "üì¶ Backend containers ({{.BACKEND_INSTANCE}}):"
      - |
        gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --command="\
          sudo -i -u deploy bash -c 'cd /home/deploy/ws_poc/deployments/v1/gcp/distributed/backend && docker-compose ps'"

  ps:ws:
    desc: Show running containers on WebSocket server instance
    cmds:
      - echo "üì¶ WebSocket server containers ({{.WS_INSTANCE}}):"
      - |
        gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} --command="\
          sudo -i -u deploy bash -c 'cd /home/deploy/ws_poc/deployments/v1/gcp/distributed/ws-server && docker-compose ps'"

  ps:all:
    desc: Show running containers on all instances
    cmds:
      - task: ps:backend
      - echo ""
      - task: ps:ws

  # === LOGS ===

  logs:backend:
    desc: View backend logs (follow mode)
    cmds:
      - |
        gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --command="\
          sudo -i -u deploy bash -c 'cd /home/deploy/ws_poc/deployments/v1/gcp/distributed/backend && docker-compose logs -f'"

  logs:ws:
    desc: View WebSocket server logs (follow mode)
    cmds:
      - |
        gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} --command="\
          sudo -i -u deploy bash -c 'cd /home/deploy/ws_poc/deployments/v1/gcp/distributed/ws-server && docker-compose logs -f'"

  logs:backend:tail:
    desc: View last 100 lines of backend logs
    cmds:
      - |
        gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --command="\
          sudo -i -u deploy bash -c 'cd /home/deploy/ws_poc/deployments/v1/gcp/distributed/backend && docker-compose logs --tail=100'"

  logs:ws:tail:
    desc: View last 100 lines of WebSocket server logs
    cmds:
      - |
        gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} --command="\
          sudo -i -u deploy bash -c 'cd /home/deploy/ws_poc/deployments/v1/gcp/distributed/ws-server && docker-compose logs --tail=100'"
