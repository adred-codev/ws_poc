version: "3"

# =============================================================================
# GCP Load Testing Tasks
# =============================================================================
# Purpose: Run load tests against GCP WebSocket server
# Scope: Capacity tests, stress tests from dedicated GCP load test instance
#
# Note: Tests run from GCP load test instance to avoid local ulimit issues
# Instance: odin-loadtest (e2-standard-8 with high ulimits)
# Load test binary: ~/ws_poc/loadtest/sustained-load-test

vars:
  LOADTEST_BINARY: "/home/deploy/ws_poc/loadtest/sustained-load-test"

tasks:
  # === CAPACITY TESTS ===

  capacity:
    desc: "CAPACITY TEST - 12K connections (matches server WS_MAX_CONNECTIONS)"
    cmds:
      - echo "ðŸ” Preparing capacity test..."
      - |
        WS_IP=$(gcloud compute instances describe {{.WS_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --format="get(networkInterfaces[0].accessConfigs[0].natIP)")

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸš€ CAPACITY TEST - 12,000 CONNECTIONS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Target:      ws://$WS_IP:3004/ws"
        echo "Connections: 12,000 (matches server limit)"
        echo "Ramp rate:   100 connections/sec"
        echo "Duration:    30 minutes"
        echo "Running from: {{.LOADTEST_INSTANCE}}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ðŸ” Stopping any existing load tests on {{.LOADTEST_INSTANCE}}..."

        # Stop existing tests and run new test in Docker
        gcloud compute ssh {{.LOADTEST_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --command="sudo su - deploy -c '\
            docker rm -f loadtest-capacity 2>/dev/null || true && \
            sleep 2 && \
            docker run -d \
              --name loadtest-capacity \
              --network host \
              -e WS_URL=ws://$WS_IP:3004/ws \
              -e HEALTH_URL=http://$WS_IP:3004/health \
              -e TARGET_CONNECTIONS=12000 \
              -e RAMP_RATE=100 \
              -e DURATION=1800 \
              loadtest:latest' && \
            echo '' && \
            echo 'âœ… Load test started in background' && \
            echo 'ðŸ“Š Monitor with: task gcp:load-test:logs'"

  capacity:short:
    desc: "CAPACITY TEST - 12K connections, 5 min"
    cmds:
      - |
        WS_IP=$(gcloud compute instances describe {{.WS_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --format="get(networkInterfaces[0].accessConfigs[0].natIP)")

        echo "ðŸš€ CAPACITY TEST - 12K connections, 5 min (from {{.LOADTEST_INSTANCE}})"

        gcloud compute ssh {{.LOADTEST_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --command="sudo su - deploy -c '\
            docker rm -f loadtest-capacity-short 2>/dev/null || true && \
            sleep 2 && \
            docker run -d \
              --name loadtest-capacity-short \
              --network host \
              -e WS_URL=ws://$WS_IP:3004/ws \
              -e HEALTH_URL=http://$WS_IP:3004/health \
              -e TARGET_CONNECTIONS=12000 \
              -e RAMP_RATE=100 \
              -e DURATION=300 \
              loadtest:latest' && \
            echo 'âœ… Load test started' && \
            echo 'ðŸ“Š Monitor with: task gcp:load-test:logs'"

  # === STRESS TESTS (Exceed server limit) ===

  stress:
    desc: "STRESS TEST - 18K connections (1.5x overload)"
    cmds:
      - |
        WS_IP=$(gcloud compute instances describe {{.WS_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --format="get(networkInterfaces[0].accessConfigs[0].natIP)")

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âš¡ STRESS TEST - 18,000 CONNECTIONS (1.5x)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Target:      ws://$WS_IP:3004/ws"
        echo "Connections: 18,000 (1.5x server limit)"
        echo "Expected:    Rejections after 12K"
        echo "Running from: {{.LOADTEST_INSTANCE}}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""

        gcloud compute ssh {{.LOADTEST_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --command="sudo su - deploy -c '\
            docker rm -f loadtest-stress 2>/dev/null || true && \
            sleep 2 && \
            docker run -d \
              --name loadtest-stress \
              --network host \
              -e WS_URL=ws://$WS_IP:3004/ws \
              -e HEALTH_URL=http://$WS_IP:3004/health \
              -e TARGET_CONNECTIONS=18000 \
              -e RAMP_RATE=200 \
              -e DURATION=1800 \
              loadtest:latest' && \
            echo 'âœ… Stress test started' && \
            echo 'ðŸ“Š Monitor with: task gcp:load-test:logs'"

  stress:heavy:
    desc: "STRESS TEST - 24K connections (2x overload)"
    cmds:
      - |
        WS_IP=$(gcloud compute instances describe {{.WS_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --format="get(networkInterfaces[0].accessConfigs[0].natIP)")

        echo "âš¡ STRESS TEST - 24K connections (2x overload, from {{.LOADTEST_INSTANCE}})"

        gcloud compute ssh {{.LOADTEST_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --command="sudo su - deploy -c '\
            docker rm -f loadtest-stress-heavy 2>/dev/null || true && \
            sleep 2 && \
            docker run -d \
              --name loadtest-stress-heavy \
              --network host \
              -e WS_URL=ws://$WS_IP:3004/ws \
              -e HEALTH_URL=http://$WS_IP:3004/health \
              -e TARGET_CONNECTIONS=24000 \
              -e RAMP_RATE=200 \
              -e DURATION=1800 \
              loadtest:latest' && \
            echo 'âœ… Heavy stress test started' && \
            echo 'ðŸ“Š Monitor with: task gcp:load-test:logs'"

  # === CUSTOM TEST ===

  custom:
    desc: "Custom load test (use CONNECTIONS, RAMP_RATE, DURATION vars)"
    vars:
      CONNECTIONS: '{{.CONNECTIONS | default "1000"}}'
      RAMP_RATE: '{{.RAMP_RATE | default "100"}}'
      DURATION: '{{.DURATION | default "600"}}'
    cmds:
      - |
        WS_IP=$(gcloud compute instances describe {{.WS_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --format="get(networkInterfaces[0].accessConfigs[0].natIP)")

        echo "ðŸš€ CUSTOM TEST (from {{.LOADTEST_INSTANCE}})"
        echo "Connections: {{.CONNECTIONS}}"
        echo "Ramp rate:   {{.RAMP_RATE}}/sec"
        echo "Duration:    {{.DURATION}}s"
        echo ""

        gcloud compute ssh {{.LOADTEST_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --command="sudo su - deploy -c '\
            docker rm -f loadtest-custom 2>/dev/null || true && \
            sleep 2 && \
            docker run -d \
              --name loadtest-custom \
              --network host \
              -e WS_URL=ws://$WS_IP:3004/ws \
              -e HEALTH_URL=http://$WS_IP:3004/health \
              -e TARGET_CONNECTIONS={{.CONNECTIONS}} \
              -e RAMP_RATE={{.RAMP_RATE}} \
              -e DURATION={{.DURATION}} \
              loadtest:latest' && \
            echo 'âœ… Custom test started' && \
            echo 'ðŸ“Š Monitor with: task gcp:load-test:logs'"

  # === PUBLISHER CONTROL ===

  start:publisher:
    desc: "Start publisher (default: 100 events/sec, 3 tokens)"
    vars:
      RATE: '{{.RATE | default "100"}}'
      TOKENS: '{{.TOKENS | default "BTC,ETH,SOL"}}'
    cmds:
      - |
        BACKEND_IP=$(gcloud compute instances describe {{.BACKEND_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --format="get(networkInterfaces[0].accessConfigs[0].natIP)")

        echo "=========================================="
        echo "ðŸš€ STARTING PUBLISHER"
        echo "=========================================="
        echo "   Backend IP - $BACKEND_IP:3003"
        echo "   Rate - {{.RATE}} events/sec"
        echo "   Tokens - {{.TOKENS}}"
        echo "   Duration - Indefinite (until stopped)"
        echo ""
        echo "   Stop - task gcp:load-test:stop:publisher"
        echo "=========================================="
        echo ""

        # Convert comma-separated tokens to JSON array
        TOKEN_ARRAY=$(echo '{{.TOKENS}}' | awk -F',' '{
          printf "["
          for(i=1; i<=NF; i++) {
            printf "\"%s\"", $i
            if(i<NF) printf ","
          }
          printf "]"
        }')

        curl -X POST "http://$BACKEND_IP:3003/start" \
          -H "Content-Type: application/json" \
          -d "{\"rate\": {{.RATE}}, \"tokenIds\": $TOKEN_ARRAY}"

        echo ""
        echo "âœ… Publisher started!"

  stop:publisher:
    desc: Stop publisher
    cmds:
      - |
        BACKEND_IP=$(gcloud compute instances describe {{.BACKEND_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --format="get(networkInterfaces[0].accessConfigs[0].natIP)")

        echo "ðŸ›‘ Stopping publisher on $BACKEND_IP:3003..."

        curl -X POST "http://$BACKEND_IP:3003/stop"

        echo ""
        echo "âœ… Publisher stopped"

  # === CONTROL ===

  stop:
    desc: Stop all load tests
    cmds:
      - echo "ðŸ›‘ Stopping load tests on {{.LOADTEST_INSTANCE}}..."
      - |
        gcloud compute ssh {{.LOADTEST_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --command="sudo su - deploy -c '\
            count=\$(docker ps -q -f name=loadtest- | wc -l) && \
            if [ \"\$count\" -gt 0 ]; then \
              echo \"ðŸ›‘ Found \$count load test container(s)\" && \
              docker stop \$(docker ps -q -f name=loadtest-) && \
              docker rm \$(docker ps -aq -f name=loadtest-) && \
              sleep 2 && \
              remaining=\$(docker ps -q -f name=loadtest- | wc -l) && \
              if [ \"\$remaining\" -eq 0 ]; then \
                echo \"âœ… All load tests stopped\" ; \
              else \
                echo \"âš ï¸  Warning: \$remaining container(s) still running\" ; \
              fi ; \
            else \
              echo \"âœ… No load tests running\" ; \
            fi'"

  logs:
    desc: Show load test logs (last run output)
    cmds:
      - echo "ðŸ“Š Fetching load test logs from {{.LOADTEST_INSTANCE}}..."
      - echo ""
      - |
        gcloud compute ssh {{.LOADTEST_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --command="sudo su - deploy -c '\
            containers=\$(docker ps -f name=loadtest- -q) && \
            if [ -n \"\$containers\" ]; then \
              echo \"ðŸ“Š Active load test containers:\" && \
              docker ps -f name=loadtest- && \
              echo \"\" && \
              for container_id in \$containers; do \
                container_name=\$(docker inspect --format=\"{{.Name}}\" \$container_id | sed \"s/^\///\") && \
                echo \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\" && \
                echo \"ðŸ“‹ Logs from: \$container_name\" && \
                echo \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\" && \
                docker logs --tail 50 \$container_id && \
                echo \"\" ; \
              done ; \
            else \
              echo \"âš ï¸  No load test containers running\" && \
              echo \"\" && \
              echo \"Checking for stopped containers...\" && \
              stopped=\$(docker ps -a -f name=loadtest- -q | head -1) && \
              if [ -n \"\$stopped\" ]; then \
                stopped_name=\$(docker inspect --format=\"{{.Name}}\" \$stopped | sed \"s/^\///\") && \
                echo \"Last 50 lines from: \$stopped_name\" && \
                echo \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\" && \
                docker logs --tail 50 \$stopped ; \
              else \
                echo \"No load test containers found (running or stopped)\" ; \
              fi ; \
            fi'"
      - echo ""
      - 'echo "ðŸ’¡ To follow live logs, run:"'
      - 'echo "   gcloud compute ssh {{.LOADTEST_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}}"'
      - 'echo "   sudo su - deploy"'
      - 'echo "   docker logs -f loadtest-capacity  # or loadtest-stress, etc."'
