version: '3'

# =============================================================================
# GCP Deployment Utilities
# =============================================================================
# Purpose: Helper functions for intelligent deployment
# Scope: State detection, smart polling, condition checking

tasks:
  # === INSTANCE STATE DETECTION ===

  check-instance-exists:
    desc: Check if an instance exists (set INSTANCE_NAME)
    silent: true
    cmds:
      - |
        if gcloud compute instances describe {{.INSTANCE_NAME}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --format="value(name)" 2>/dev/null | grep -q "{{.INSTANCE_NAME}}"; then
          echo "true"
        else
          echo "false"
        fi

  check-instance-running:
    desc: Check if an instance is running (set INSTANCE_NAME)
    silent: true
    cmds:
      - |
        STATUS=$(gcloud compute instances describe {{.INSTANCE_NAME}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --format="value(status)" 2>/dev/null || echo "NOT_FOUND")

        if [ "$STATUS" = "RUNNING" ]; then
          echo "true"
        else
          echo "false"
        fi

  wait-for-instance-ssh:
    desc: Wait for instance SSH to be ready (set INSTANCE_NAME, timeout 300s)
    cmds:
      - |
        echo "â³ Waiting for {{.INSTANCE_NAME}} SSH to be ready..."
        TIMEOUT={{.TIMEOUT | default "300"}}
        ELAPSED=0
        INTERVAL=10

        while [ $ELAPSED -lt $TIMEOUT ]; do
          if gcloud compute ssh {{.INSTANCE_NAME}} \
            --zone={{.GCP_ZONE}} \
            --project={{.GCP_PROJECT}} \
            --command="echo 'SSH ready'" \
            --ssh-flag="-o ConnectTimeout=5" \
            --ssh-flag="-o StrictHostKeyChecking=no" \
            2>/dev/null | grep -q "SSH ready"; then
            echo "âœ… {{.INSTANCE_NAME}} SSH is ready (${ELAPSED}s)"
            exit 0
          fi

          echo "   Still waiting... (${ELAPSED}s/${TIMEOUT}s)"
          sleep $INTERVAL
          ELAPSED=$((ELAPSED + INTERVAL))
        done

        echo "âŒ Timeout waiting for {{.INSTANCE_NAME}} SSH"
        exit 1

  wait-for-startup-script:
    desc: Wait for instance startup script to complete (set INSTANCE_NAME)
    cmds:
      - |
        echo "â³ Waiting for {{.INSTANCE_NAME}} startup script to complete..."
        TIMEOUT=300
        ELAPSED=0
        INTERVAL=10

        while [ $ELAPSED -lt $TIMEOUT ]; do
          if gcloud compute ssh {{.INSTANCE_NAME}} \
            --zone={{.GCP_ZONE}} \
            --project={{.GCP_PROJECT}} \
            --command="test -f /var/log/startup-complete.log && echo 'COMPLETE' || echo 'PENDING'" \
            --ssh-flag="-o ConnectTimeout=5" \
            --ssh-flag="-o StrictHostKeyChecking=no" \
            2>/dev/null | grep -q "COMPLETE"; then
            echo "âœ… {{.INSTANCE_NAME}} startup script complete (${ELAPSED}s)"
            exit 0
          fi

          echo "   Still waiting... (${ELAPSED}s/${TIMEOUT}s)"
          sleep $INTERVAL
          ELAPSED=$((ELAPSED + INTERVAL))
        done

        echo "âŒ Timeout waiting for startup script"
        exit 1

  # === SERVICE STATE DETECTION ===

  check-repo-cloned:
    desc: Check if repo is cloned on instance (set INSTANCE_NAME)
    silent: true
    cmds:
      - |
        RESULT=$(gcloud compute ssh {{.INSTANCE_NAME}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --command="sudo -u deploy test -d /home/deploy/ws_poc && echo 'true' || echo 'false'" \
          2>/dev/null || echo "false")
        echo "$RESULT"

  check-docker-running:
    desc: Check if Docker is running on instance (set INSTANCE_NAME)
    silent: true
    cmds:
      - |
        RESULT=$(gcloud compute ssh {{.INSTANCE_NAME}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --command="sudo systemctl is-active docker 2>/dev/null" \
          2>/dev/null || echo "inactive")

        if [ "$RESULT" = "active" ]; then
          echo "true"
        else
          echo "false"
        fi

  check-containers-running:
    desc: Check if any containers are running on instance (set INSTANCE_NAME)
    silent: true
    cmds:
      - |
        COUNT=$(gcloud compute ssh {{.INSTANCE_NAME}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --command="docker ps -q 2>/dev/null | wc -l" \
          2>/dev/null || echo "0")

        if [ "$COUNT" -gt "0" ]; then
          echo "true"
        else
          echo "false"
        fi

  # === KAFKA/REDPANDA UTILITIES ===

  check-topics-exist:
    desc: Check if Kafka topics exist on backend
    silent: true
    cmds:
      - |
        TOPICS=$(gcloud compute ssh {{.BACKEND_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --command="docker exec redpanda rpk topic list 2>/dev/null" \
          2>/dev/null || echo "")

        REQUIRED_TOPICS="odin.trades odin.liquidity odin.balances odin.metadata odin.social odin.community odin.creation odin.analytics"
        ALL_EXIST=true

        for topic in $REQUIRED_TOPICS; do
          if ! echo "$TOPICS" | grep -q "$topic"; then
            ALL_EXIST=false
            break
          fi
        done

        if [ "$ALL_EXIST" = "true" ]; then
          echo "true"
        else
          echo "false"
        fi

  # === FIREWALL UTILITIES ===

  check-firewall-exists:
    desc: Check if firewall rule exists (set RULE_NAME)
    silent: true
    cmds:
      - |
        if gcloud compute firewall-rules describe {{.RULE_NAME}} \
          --project={{.GCP_PROJECT}} \
          --format="value(name)" 2>/dev/null | grep -q "{{.RULE_NAME}}"; then
          echo "true"
        else
          echo "false"
        fi

  # === STATIC IP UTILITIES ===

  check-static-ip-exists:
    desc: Check if static IP exists (set IP_NAME)
    silent: true
    cmds:
      - |
        if gcloud compute addresses describe {{.IP_NAME}} \
          --region={{.GCP_REGION}} \
          --project={{.GCP_PROJECT}} \
          --format="value(address)" 2>/dev/null; then
          echo "true"
        else
          echo "false"
        fi

  get-static-ip:
    desc: Get static IP address (set IP_NAME)
    silent: true
    cmds:
      - |
        gcloud compute addresses describe {{.IP_NAME}} \
          --region={{.GCP_REGION}} \
          --project={{.GCP_PROJECT}} \
          --format="value(address)" 2>/dev/null || echo ""

  # === HEALTH CHECK UTILITIES ===

  wait-for-http-endpoint:
    desc: Wait for HTTP endpoint to respond (set INSTANCE_NAME, PORT, PATH)
    cmds:
      - |
        ENDPOINT="{{.PATH | default "/health"}}"
        PORT="{{.PORT}}"
        TIMEOUT={{.TIMEOUT | default "120"}}
        ELAPSED=0
        INTERVAL=5

        echo "â³ Waiting for {{.INSTANCE_NAME}}:${PORT}${ENDPOINT} to respond..."

        while [ $ELAPSED -lt $TIMEOUT ]; do
          if gcloud compute ssh {{.INSTANCE_NAME}} \
            --zone={{.GCP_ZONE}} \
            --project={{.GCP_PROJECT}} \
            --command="curl -sf http://localhost:${PORT}${ENDPOINT}" \
            2>/dev/null >/dev/null; then
            echo "âœ… Endpoint is responding (${ELAPSED}s)"
            exit 0
          fi

          echo "   Still waiting... (${ELAPSED}s/${TIMEOUT}s)"
          sleep $INTERVAL
          ELAPSED=$((ELAPSED + INTERVAL))
        done

        echo "âš ï¸  Endpoint not responding after ${TIMEOUT}s (may still be starting)"
        exit 0  # Don't fail - just warn

  # === SECURE EXECUTION ===

  ssh-exec:
    desc: Execute command on instance securely (set INSTANCE_NAME, COMMAND)
    silent: true
    cmds:
      - |
        gcloud compute ssh {{.INSTANCE_NAME}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --command="{{.COMMAND}}" \
          2>/dev/null

  ssh-exec-as-deploy:
    desc: Execute command as deploy user (set INSTANCE_NAME, COMMAND)
    silent: true
    cmds:
      - |
        gcloud compute ssh {{.INSTANCE_NAME}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --command="sudo -u deploy bash -c '{{.COMMAND}}'" \
          2>/dev/null

  # === DEPLOYMENT STATE SUMMARY ===

  show-deployment-state:
    desc: Show current deployment state
    cmds:
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š DEPLOYMENT STATE"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""

        # Check backend instance
        BACKEND_EXISTS=$(task :gcp:utilities:check-instance-exists INSTANCE_NAME={{.BACKEND_INSTANCE}})
        BACKEND_RUNNING=$(task :gcp:utilities:check-instance-running INSTANCE_NAME={{.BACKEND_INSTANCE}})
        echo "Backend Instance ({{.BACKEND_INSTANCE}}):"
        echo "  Exists: $BACKEND_EXISTS"
        echo "  Running: $BACKEND_RUNNING"

        # Check WS instance
        WS_EXISTS=$(task :gcp:utilities:check-instance-exists INSTANCE_NAME={{.WS_INSTANCE}})
        WS_RUNNING=$(task :gcp:utilities:check-instance-running INSTANCE_NAME={{.WS_INSTANCE}})
        echo "WS Instance ({{.WS_INSTANCE}}):"
        echo "  Exists: $WS_EXISTS"
        echo "  Running: $WS_RUNNING"

        # Check loadtest instance
        LT_EXISTS=$(task :gcp:utilities:check-instance-exists INSTANCE_NAME={{.LOADTEST_INSTANCE}})
        LT_RUNNING=$(task :gcp:utilities:check-instance-running INSTANCE_NAME={{.LOADTEST_INSTANCE}})
        echo "Loadtest Instance ({{.LOADTEST_INSTANCE}}):"
        echo "  Exists: $LT_EXISTS"
        echo "  Running: $LT_RUNNING"

        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
