version: "3"

# =============================================================================
# GCP Deployment Tasks
# =============================================================================
# Purpose: GCP infrastructure and application deployment
# Scope: Instance creation, firewall, initial setup, code updates

tasks:
  # === HIGH-LEVEL WORKFLOWS ===

  setup:
    desc: Complete GCP deployment from scratch (fully automated)
    cmds:
      - task: "infrastructure"
      - echo ""
      - echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      - echo "ü§ñ AUTOMATED APPLICATION SETUP"
      - echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      - echo ""
      - task: "setup:backend"
      - echo ""
      - task: "setup:ws"
      - echo ""
      - task: "setup:loadtest"
      - echo ""
      - echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      - echo "‚úÖ DEPLOYMENT COMPLETE"
      - echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

  quick-start:
    desc: Quick start all services (daily use - assumes infrastructure exists)
    cmds:
      - echo "üöÄ Starting all GCP services..."
      - echo ""
      - task: :gcp:start:all
      - echo ""
      - echo "‚è≥ Waiting for services to be ready..."
      - sleep 15
      - echo ""
      - task: health:all
      - echo ""
      - task: stats:urls
      - echo ""
      - echo "‚úÖ All services started and healthy"

  stop:
    desc: Stop all services (keeps volumes)
    cmds:
      - task: :gcp:stop:all
      - echo "‚úÖ Services stopped (containers removed, infrastructure preserved)"

  reset:
    desc: Reset deployment (stop + rebuild + start - for config changes)
    cmds:
      - echo "‚ö†Ô∏è  Resetting deployment (stop + rebuild + start)..."
      - echo "   Press Ctrl+C to cancel, or wait 5 seconds..."
      - sleep 5
      - task: :gcp:stop:all
      - echo "üî® Rebuilding services..."
      - task: "rebuild:all"
      - echo "‚è≥ Waiting for services to be ready..."
      - sleep 15
      - task: health:all
      - echo "‚úÖ Deployment reset complete"

  rebuild-code:
    desc: Rebuild services after code changes
    cmds:
      - echo "üî® Rebuilding services..."
      - task: "rebuild:all"
      - echo "üîç Checking health..."
      - sleep 5
      - task: health:all
      - echo "‚úÖ Rebuild complete"

  show-urls:
    desc: Display service URLs
    cmds:
      - task: :stats:urls

  infrastructure:
    desc: Complete infrastructure setup (instances + networking + IP)
    cmds:
      - echo "üèóÔ∏è  Starting complete infrastructure setup..."
      - echo ""
      - echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      - 'echo "Phase 1: Creating GCP Instances"'
      - echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      - task: "create:backend"
      - echo ""
      - task: "create:ws"
      - echo ""
      - task: "create:loadtest"
      - echo ""
      - echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      - 'echo "Phase 2: Configuring Firewall Rules"'
      - echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      - task: "firewall:backend"
      - echo ""
      - task: "firewall:ws"
      - echo ""
      - echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      - 'echo "Phase 3: Reserving Static IP"'
      - echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      - task: "reserve-ip:ws"
      - echo ""
      - echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      - echo "‚úÖ INFRASTRUCTURE SETUP COMPLETE"
      - echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      - echo ""
      - 'echo "üí° Next steps:"'
      - 'echo "   Complete setup: task gcp:deploy"'
      - 'echo "   Or run individually:"'
      - 'echo "     - task gcp:deployment:setup:backend"'
      - 'echo "     - task gcp:deployment:setup:ws"'
      - 'echo "     - task gcp:deployment:setup:loadtest"'

  # === INFRASTRUCTURE SETUP (Individual Tasks) ===

  create:backend:
    desc: Create backend GCP instance (e2-medium) - smart, idempotent
    cmds:
      - |
        echo "üîç Checking backend instance..."
        if gcloud compute instances describe {{.BACKEND_INSTANCE}} \
          --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} \
          --format="value(status)" 2>/dev/null | grep -q "RUNNING"; then
          echo "‚úÖ Backend already running"
          exit 0
        fi

        if gcloud compute instances describe {{.BACKEND_INSTANCE}} \
          --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} \
          2>/dev/null | grep -q "name:"; then
          echo "‚ö° Starting existing instance..."
          gcloud compute instances start {{.BACKEND_INSTANCE}} \
            --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --quiet
        else
          echo "üì¶ Creating new instance..."
          gcloud compute instances create {{.BACKEND_INSTANCE}} \
            --project={{.GCP_PROJECT}} --zone={{.GCP_ZONE}} \
            --machine-type=e2-medium --image-family=ubuntu-2204-lts \
            --image-project=ubuntu-os-cloud --boot-disk-size=20GB \
            --boot-disk-type=pd-standard --tags=odin-backend --quiet \
            --metadata=startup-script='#!/bin/bash
              apt-get update && apt-get install -y docker.io docker-compose git curl jq
              systemctl enable docker && systemctl start docker
              usermod -aG docker $(whoami)
              id -u deploy &>/dev/null || useradd -m -s /bin/bash deploy
              usermod -aG docker deploy
              echo "* soft nofile 262144" >> /etc/security/limits.conf
              echo "* hard nofile 262144" >> /etc/security/limits.conf
              echo "fs.file-max = 524288" >> /etc/sysctl.conf
              echo "net.ipv4.ip_local_port_range = 1024 65535" >> /etc/sysctl.conf
              echo "net.ipv4.tcp_tw_reuse = 1" >> /etc/sysctl.conf
              echo "net.core.somaxconn = 32768" >> /etc/sysctl.conf
              sysctl -p && echo "Startup completed" > /var/log/startup-complete.log'
        fi

        echo "‚è≥ Waiting for SSH..."
        for i in {1..30}; do
          if gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} \
            --project={{.GCP_PROJECT}} --command="echo ok" \
            --ssh-flag="-o ConnectTimeout=5" --ssh-flag="-o StrictHostKeyChecking=no" \
            2>/dev/null | grep -q "ok"; then
            echo "‚úÖ SSH ready ($((i*10))s)"
            break
          fi
          sleep 10
        done

        echo "‚è≥ Waiting for startup script..."
        for i in {1..30}; do
          if gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} \
            --project={{.GCP_PROJECT}} --command="test -f /var/log/startup-complete.log && echo ok" \
            --ssh-flag="-o ConnectTimeout=5" --ssh-flag="-o StrictHostKeyChecking=no" \
            2>/dev/null | grep -q "ok"; then
            echo "‚úÖ Backend ready ($((i*10))s)"
            exit 0
          fi
          sleep 10
        done
        echo "‚ö†Ô∏è  Startup timeout (may still be installing)"

  create:ws:
    desc: Create WebSocket server GCP instance (e2-standard-4) - smart, idempotent
    cmds:
      - |
        echo "üîç Checking WS server instance..."
        if gcloud compute instances describe {{.WS_INSTANCE}} \
          --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} \
          --format="value(status)" 2>/dev/null | grep -q "RUNNING"; then
          echo "‚úÖ WS server already running"
          exit 0
        fi

        if gcloud compute instances describe {{.WS_INSTANCE}} \
          --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} \
          2>/dev/null | grep -q "name:"; then
          echo "‚ö° Starting existing instance..."
          gcloud compute instances start {{.WS_INSTANCE}} \
            --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --quiet
        else
          echo "üì¶ Creating new instance..."
          gcloud compute instances create {{.WS_INSTANCE}} \
            --project={{.GCP_PROJECT}} --zone={{.GCP_ZONE}} \
            --machine-type=e2-standard-4 --image-family=ubuntu-2204-lts \
            --image-project=ubuntu-os-cloud --boot-disk-size=20GB \
            --boot-disk-type=pd-standard --tags=odin-ws-server --quiet \
            --metadata=startup-script='#!/bin/bash
              apt-get update && apt-get install -y docker.io docker-compose git curl jq
              systemctl enable docker && systemctl start docker
              usermod -aG docker $(whoami)
              id -u deploy &>/dev/null || useradd -m -s /bin/bash deploy
              usermod -aG docker deploy
              echo "* soft nofile 1048576" >> /etc/security/limits.conf
              echo "* hard nofile 1048576" >> /etc/security/limits.conf
              echo "fs.file-max = 2097152" >> /etc/sysctl.conf
              echo "net.ipv4.ip_local_port_range = 1024 65535" >> /etc/sysctl.conf
              echo "net.ipv4.tcp_tw_reuse = 1" >> /etc/sysctl.conf
              echo "net.core.somaxconn = 65535" >> /etc/sysctl.conf
              echo "net.ipv4.tcp_max_syn_backlog = 65535" >> /etc/sysctl.conf
              sysctl -p && echo "Startup completed" > /var/log/startup-complete.log'
        fi

        echo "‚è≥ Waiting for SSH..."
        for i in {1..30}; do
          if gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} \
            --project={{.GCP_PROJECT}} --command="echo ok" \
            --ssh-flag="-o ConnectTimeout=5" --ssh-flag="-o StrictHostKeyChecking=no" \
            2>/dev/null | grep -q "ok"; then
            echo "‚úÖ SSH ready ($((i*10))s)"
            break
          fi
          sleep 10
        done

        echo "‚è≥ Waiting for startup script..."
        for i in {1..30}; do
          if gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} \
            --project={{.GCP_PROJECT}} --command="test -f /var/log/startup-complete.log && echo ok" \
            --ssh-flag="-o ConnectTimeout=5" --ssh-flag="-o StrictHostKeyChecking=no" \
            2>/dev/null | grep -q "ok"; then
            echo "‚úÖ WS server ready ($((i*10))s)"
            exit 0
          fi
          sleep 10
        done
        echo "‚ö†Ô∏è  Startup timeout (may still be installing)"

  create:loadtest:
    desc: Create load test GCP instance (e2-standard-8) - smart, idempotent
    cmds:
      - |
        echo "üîç Checking loadtest instance..."
        if gcloud compute instances describe {{.LOADTEST_INSTANCE}} \
          --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} \
          --format="value(status)" 2>/dev/null | grep -q "RUNNING"; then
          echo "‚úÖ Loadtest already running"
          exit 0
        fi

        if gcloud compute instances describe {{.LOADTEST_INSTANCE}} \
          --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} \
          2>/dev/null | grep -q "name:"; then
          echo "‚ö° Starting existing instance..."
          gcloud compute instances start {{.LOADTEST_INSTANCE}} \
            --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --quiet
        else
          echo "üì¶ Creating new instance..."
          gcloud compute instances create {{.LOADTEST_INSTANCE}} \
            --project={{.GCP_PROJECT}} --zone={{.GCP_ZONE}} \
            --machine-type=e2-standard-8 --image-family=ubuntu-2204-lts \
            --image-project=ubuntu-os-cloud --boot-disk-size=30GB \
            --boot-disk-type=pd-standard --tags=odin-loadtest --quiet \
            --metadata=startup-script='#!/bin/bash
              apt-get update && apt-get install -y docker.io docker-compose git curl jq
              systemctl enable docker && systemctl start docker
              usermod -aG docker $(whoami)
              id -u deploy &>/dev/null || useradd -m -s /bin/bash deploy
              usermod -aG docker deploy
              echo "* soft nofile 1048576" >> /etc/security/limits.conf
              echo "* hard nofile 1048576" >> /etc/security/limits.conf
              echo "fs.file-max = 2097152" >> /etc/sysctl.conf
              echo "net.ipv4.ip_local_port_range = 1024 65535" >> /etc/sysctl.conf
              echo "net.ipv4.tcp_tw_reuse = 1" >> /etc/sysctl.conf
              echo "net.core.somaxconn = 65535" >> /etc/sysctl.conf
              echo "net.ipv4.tcp_max_syn_backlog = 65535" >> /etc/sysctl.conf
              sysctl -p && echo "Startup completed" > /var/log/startup-complete.log'
        fi

        echo "‚è≥ Waiting for SSH..."
        for i in {1..30}; do
          if gcloud compute ssh {{.LOADTEST_INSTANCE}} --zone={{.GCP_ZONE}} \
            --project={{.GCP_PROJECT}} --command="echo ok" \
            --ssh-flag="-o ConnectTimeout=5" --ssh-flag="-o StrictHostKeyChecking=no" \
            2>/dev/null | grep -q "ok"; then
            echo "‚úÖ SSH ready ($((i*10))s)"
            break
          fi
          sleep 10
        done

        echo "‚è≥ Waiting for startup script..."
        for i in {1..30}; do
          if gcloud compute ssh {{.LOADTEST_INSTANCE}} --zone={{.GCP_ZONE}} \
            --project={{.GCP_PROJECT}} --command="test -f /var/log/startup-complete.log && echo ok" \
            --ssh-flag="-o ConnectTimeout=5" --ssh-flag="-o StrictHostKeyChecking=no" \
            2>/dev/null | grep -q "ok"; then
            echo "‚úÖ Loadtest ready ($((i*10))s)"
            exit 0
          fi
          sleep 10
        done
        echo "‚ö†Ô∏è  Startup timeout (may still be installing)"

  # === DELETE INSTANCES ===

  delete:backend:
    desc: Delete backend GCP instance (saves costs)
    cmds:
      - echo "Deleting backend instance..."
      - echo "WARNING - This will permanently delete the instance and all data!"
      - echo ""
      - |
        read -p "Type 'yes' to confirm deletion: " CONFIRM
        if [ "$CONFIRM" = "yes" ]; then
          gcloud compute instances delete {{.BACKEND_INSTANCE}} \
            --zone={{.GCP_ZONE}} \
            --project={{.GCP_PROJECT}} \
            --quiet
          echo "Backend instance deleted"
        else
          echo "Deletion cancelled"
        fi

  delete:ws:
    desc: Delete WebSocket server GCP instance (saves costs)
    cmds:
      - echo "Deleting WebSocket server instance..."
      - echo "WARNING - This will permanently delete the instance and all data!"
      - echo ""
      - |
        read -p "Type 'yes' to confirm deletion: " CONFIRM
        if [ "$CONFIRM" = "yes" ]; then
          gcloud compute instances delete {{.WS_INSTANCE}} \
            --zone={{.GCP_ZONE}} \
            --project={{.GCP_PROJECT}} \
            --quiet
          echo "WebSocket server instance deleted"
        else
          echo "Deletion cancelled"
        fi

  delete:loadtest:
    desc: Delete load test GCP instance (saves costs when not testing)
    cmds:
      - echo "Deleting load test instance..."
      - echo "WARNING - This will permanently delete the instance and all data!"
      - echo ""
      - |
        read -p "Type 'yes' to confirm deletion: " CONFIRM
        if [ "$CONFIRM" = "yes" ]; then
          gcloud compute instances delete {{.LOADTEST_INSTANCE}} \
            --zone={{.GCP_ZONE}} \
            --project={{.GCP_PROJECT}} \
            --quiet
          echo "Load test instance deleted"
          echo ""
          echo "Recreate when needed - task gcp:deployment:create:loadtest"
        else
          echo "Deletion cancelled"
        fi

  delete:all:
    desc: Delete ALL GCP instances (DESTRUCTIVE - saves maximum costs)
    cmds:
      - echo "Deleting ALL GCP instances..."
      - echo ""
      - 'echo "WARNING - This will delete ALL instances:"'
      - 'echo "   - {{.BACKEND_INSTANCE}} (backend)"'
      - 'echo "   - {{.WS_INSTANCE}} (WebSocket server)"'
      - 'echo "   - {{.LOADTEST_INSTANCE}} (load test)"'
      - echo ""
      - echo "All data will be permanently lost!"
      - echo ""
      - |
        read -p "Type 'DELETE-ALL' to confirm: " CONFIRM
        if [ "$CONFIRM" = "DELETE-ALL" ]; then
          echo ""
          echo "Deleting instances..."
          gcloud compute instances delete {{.BACKEND_INSTANCE}} {{.WS_INSTANCE}} {{.LOADTEST_INSTANCE}} \
            --zone={{.GCP_ZONE}} \
            --project={{.GCP_PROJECT}} \
            --quiet
          echo ""
          echo "All instances deleted"
          echo ""
          echo "Recreate infrastructure with - task gcp:deployment:infrastructure"
        else
          echo "Deletion cancelled"
        fi

  # === FIREWALL RULES ===

  firewall:backend:
    desc: Create backend firewall rules
    cmds:
      - echo "üî• Creating backend firewall rules..."
      - |
        # Grafana (public access for management)
        gcloud compute firewall-rules create odin-backend-grafana \
          --project={{.GCP_PROJECT}} \
          --direction=INGRESS \
          --priority=1000 \
          --network=default \
          --action=ALLOW \
          --rules=tcp:3010 \
          --source-ranges=0.0.0.0/0 \
          --target-tags=odin-backend \
          2>/dev/null || echo "‚ö†Ô∏è  Grafana firewall rule already exists"

        # Redpanda Console (public access for management)
        gcloud compute firewall-rules create odin-backend-console \
          --project={{.GCP_PROJECT}} \
          --direction=INGRESS \
          --priority=1000 \
          --network=default \
          --action=ALLOW \
          --rules=tcp:8080 \
          --source-ranges=0.0.0.0/0 \
          --target-tags=odin-backend \
          2>/dev/null || echo "‚ö†Ô∏è  Console firewall rule already exists"

        # Kafka (internal access from WS server)
        gcloud compute firewall-rules create odin-backend-kafka \
          --project={{.GCP_PROJECT}} \
          --direction=INGRESS \
          --priority=1000 \
          --network=default \
          --action=ALLOW \
          --rules=tcp:9092 \
          --source-tags=odin-ws-server \
          --target-tags=odin-backend \
          2>/dev/null || echo "‚ö†Ô∏è  Kafka firewall rule already exists"

        # Loki (internal access from WS server)
        gcloud compute firewall-rules create odin-backend-loki \
          --project={{.GCP_PROJECT}} \
          --direction=INGRESS \
          --priority=1000 \
          --network=default \
          --action=ALLOW \
          --rules=tcp:3100 \
          --source-tags=odin-ws-server \
          --target-tags=odin-backend \
          2>/dev/null || echo "‚ö†Ô∏è  Loki firewall rule already exists"
      - echo "‚úÖ Backend firewall rules created"

  firewall:ws:
    desc: Create WebSocket server firewall rules
    cmds:
      - echo "üî• Creating WebSocket server firewall rules..."
      - |
        # WebSocket + Health endpoint (public access)
        gcloud compute firewall-rules create odin-ws-server-public \
          --project={{.GCP_PROJECT}} \
          --direction=INGRESS \
          --priority=1000 \
          --network=default \
          --action=ALLOW \
          --rules=tcp:3004 \
          --source-ranges=0.0.0.0/0 \
          --target-tags=odin-ws-server \
          2>/dev/null || echo "‚ö†Ô∏è  WebSocket firewall rule already exists"
      - echo "‚úÖ WebSocket server firewall rules created"

  # === STATIC IP ===

  reserve-ip:ws:
    desc: Reserve static IP for WebSocket server
    cmds:
      - echo "üìç Reserving static IP for WebSocket server..."
      - |
        gcloud compute addresses create {{.WS_INSTANCE}}-static-ip \
          --region={{.GCP_REGION}} \
          --project={{.GCP_PROJECT}} \
          2>/dev/null || echo "‚ö†Ô∏è  Static IP already exists"
      - |
        STATIC_IP=$(gcloud compute addresses describe {{.WS_INSTANCE}}-static-ip \
          --region={{.GCP_REGION}} \
          --project={{.GCP_PROJECT}} \
          --format='get(address)')
        echo "Static IP: $STATIC_IP"
      - |
        # Remove existing access config
        gcloud compute instances delete-access-config {{.WS_INSTANCE}} \
          --access-config-name="external-nat" \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          2>/dev/null || true
      - |
        # Assign static IP
        STATIC_IP=$(gcloud compute addresses describe {{.WS_INSTANCE}}-static-ip \
          --region={{.GCP_REGION}} \
          --project={{.GCP_PROJECT}} \
          --format='get(address)')
        gcloud compute instances add-access-config {{.WS_INSTANCE}} \
          --access-config-name="external-nat" \
          --address=$STATIC_IP \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}}
      - echo "‚úÖ Static IP assigned"

  # === APPLICATION SETUP ===

  setup:backend:
    desc: Automated backend setup (secure PAT handling, idempotent)
    cmds:
      - |
        echo "ü§ñ Automated Backend Setup"

        # Build clone URL SECURELY (NEVER echo this variable)
        if [ -n "{{.GIT_PAT}}" ]; then
          CLONE_URL="https://{{.GIT_PAT}}@github.com/adred-codev/ws_poc.git"
          echo "üîê Using authenticated clone"
        else
          CLONE_URL="{{.GIT_REPO_HTTPS}}"
          echo "üåê Using public clone"
        fi

        # Check if repo exists
        REPO_EXISTS=$(gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="sudo -i -u deploy test -d /home/deploy/ws_poc && echo true || echo false" 2>/dev/null || echo "false")

        if [ "$REPO_EXISTS" = "true" ]; then
          echo "‚úÖ Repository exists, updating..."
          gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="sudo -i -u deploy bash -c 'cd /home/deploy/ws_poc && git fetch origin {{.GIT_BRANCH}} 2>&1 | grep -v From && git reset --hard origin/{{.GIT_BRANCH}} 2>&1 | head -1'" 2>/dev/null
        else
          echo "üì¶ Cloning repository..."
          gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="sudo -i -u deploy git clone -b {{.GIT_BRANCH}} -q $CLONE_URL /home/deploy/ws_poc" 2>&1 | grep -v "Cloning" | grep -v "remote" || true
        fi

        echo "üê≥ Starting Docker services..."
        gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="sudo -i -u deploy bash -c 'cd /home/deploy/ws_poc/deployments/v1/gcp/distributed/backend && docker-compose up -d 2>&1 | grep -E \"(Created|Started|Running)\"'" 2>/dev/null || true
        sleep 15

        # Create topics if needed
        TOPICS=$(gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="docker exec redpanda rpk topic list 2>/dev/null | grep -q odin.trades && echo exists || echo missing" 2>/dev/null || echo "missing")

        if [ "$TOPICS" = "missing" ]; then
          echo "üìã Creating Kafka topics..."
          gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="docker exec redpanda rpk topic create odin.trades odin.liquidity odin.balances odin.metadata odin.social odin.community odin.creation odin.analytics --partitions 12 --replicas 1 2>&1 | grep TOPIC" 2>/dev/null || true
        else
          echo "‚úÖ Topics already exist"
        fi

        echo "‚úÖ Backend setup complete"

  setup:ws:
    desc: Automated WS setup (secure PAT handling, idempotent)
    cmds:
      - |
        echo "ü§ñ Automated WebSocket Server Setup"

        # Get backend IP
        BACKEND_IP=$(gcloud compute instances describe {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --format='get(networkInterfaces[0].networkIP)')
        echo "Backend IP: $BACKEND_IP"

        # Build clone URL SECURELY (NEVER echo this variable)
        if [ -n "{{.GIT_PAT}}" ]; then
          CLONE_URL="https://{{.GIT_PAT}}@github.com/adred-codev/ws_poc.git"
          echo "üîê Using authenticated clone"
        else
          CLONE_URL="{{.GIT_REPO_HTTPS}}"
          echo "üåê Using public clone"
        fi

        # Check if repo exists
        REPO_EXISTS=$(gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="sudo -i -u deploy test -d /home/deploy/ws_poc && echo true || echo false" 2>/dev/null || echo "false")

        if [ "$REPO_EXISTS" = "true" ]; then
          echo "‚úÖ Repository exists, updating..."
          gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="sudo -i -u deploy bash -c 'cd /home/deploy/ws_poc && git fetch origin {{.GIT_BRANCH}} 2>&1 | grep -v From && git reset --hard origin/{{.GIT_BRANCH}} 2>&1 | head -1'" 2>/dev/null
        else
          echo "üì¶ Cloning repository..."
          gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="sudo -i -u deploy git clone -b {{.GIT_BRANCH}} -q $CLONE_URL /home/deploy/ws_poc" 2>&1 | grep -v "Cloning" | grep -v "remote" || true
        fi

        echo "‚öôÔ∏è  Configuring environment..."
        gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="sudo -i -u deploy bash -c 'echo BACKEND_INTERNAL_IP=$BACKEND_IP > /home/deploy/ws_poc/deployments/v1/gcp/distributed/ws-server/.env.production && chmod 600 /home/deploy/ws_poc/deployments/v1/gcp/distributed/ws-server/.env.production'" 2>/dev/null

        echo "üê≥ Starting Docker services..."
        gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="sudo -i -u deploy bash -c 'cd /home/deploy/ws_poc/deployments/v1/gcp/distributed/ws-server && export BACKEND_INTERNAL_IP=$BACKEND_IP && docker-compose up -d 2>&1 | grep -E \"(Created|Started|Running)\"'" 2>/dev/null || true
        sleep 15

        echo "‚úÖ WS server setup complete"

  setup:loadtest:
    desc: Automated loadtest setup (secure PAT handling, idempotent)
    cmds:
      - |
        echo "ü§ñ Automated Load Test Setup"

        # Build clone URL SECURELY (NEVER echo this variable)
        if [ -n "{{.GIT_PAT}}" ]; then
          CLONE_URL="https://{{.GIT_PAT}}@github.com/adred-codev/ws_poc.git"
          echo "üîê Using authenticated clone"
        else
          CLONE_URL="{{.GIT_REPO_HTTPS}}"
          echo "üåê Using public clone"
        fi

        # Check if repo exists
        REPO_EXISTS=$(gcloud compute ssh {{.LOADTEST_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="sudo -i -u deploy test -d /home/deploy/ws_poc && echo true || echo false" 2>/dev/null || echo "false")

        if [ "$REPO_EXISTS" = "true" ]; then
          echo "‚úÖ Repository exists, updating..."
          gcloud compute ssh {{.LOADTEST_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="sudo -i -u deploy bash -c 'cd /home/deploy/ws_poc && git fetch origin {{.GIT_BRANCH}} 2>&1 | grep -v From && git reset --hard origin/{{.GIT_BRANCH}} 2>&1 | head -1'" 2>/dev/null
        else
          echo "üì¶ Cloning repository..."
          gcloud compute ssh {{.LOADTEST_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="sudo -i -u deploy git clone -b {{.GIT_BRANCH}} -q $CLONE_URL /home/deploy/ws_poc" 2>&1 | grep -v "Cloning" | grep -v "remote" || true
        fi

        # Build Docker image (use sudo docker like old deployment - group membership not active yet)
        echo "üê≥ Building Docker image..."
        gcloud compute ssh {{.LOADTEST_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="sudo docker build -t loadtest /home/deploy/ws_poc/loadtest 2>&1 | tail -10" 2>/dev/null || true

        # Verify image was built
        IMAGE_EXISTS=$(gcloud compute ssh {{.LOADTEST_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="sudo docker images -q loadtest 2>/dev/null" 2>/dev/null)

        if [ -n "$IMAGE_EXISTS" ]; then
          echo "‚úÖ Load test Docker image ready"
        else
          echo "‚ùå Failed to build Docker image"
          exit 1
        fi

        echo "‚úÖ Load test setup complete"

  # === CODE UPDATES / REBUILDS ===

  rebuild:backend:
    desc: Rebuild backend with latest code
    cmds:
      - echo "üîÑ Rebuilding backend code..."
      - |
        gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="\
          sudo su - deploy -c '\
            cd ws_poc && \
            git pull origin {{.GIT_BRANCH}} && \
            cd deployments/v1/gcp/distributed/backend && \
            docker compose build && \
            docker compose up -d && \
            sleep 10 && \
            curl -sf http://localhost:3003/status'"
      - echo "‚úÖ Backend rebuilt"
      - task: :gcp:health:backend

  rebuild:ws:
    desc: Rebuild WebSocket server with latest code
    cmds:
      - echo "üîÑ Rebuilding WebSocket server code..."
      - |
        BACKEND_IP=$(gcloud compute instances describe {{.BACKEND_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --project={{.GCP_PROJECT}} \
          --format='get(networkInterfaces[0].networkIP)')

        gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}} --command="\
          sudo su - deploy -c '\
            cd ws_poc && \
            git pull origin {{.GIT_BRANCH}} && \
            cd deployments/v1/gcp/distributed/ws-server && \
            export BACKEND_INTERNAL_IP=$BACKEND_IP && \
            docker compose build && \
            docker compose up -d && \
            sleep 10 && \
            curl -sf http://localhost:3004/health'"
      - echo "‚úÖ WebSocket server rebuilt"
      - task: :gcp:health:ws

  rebuild:all:
    desc: Rebuild all services with latest code
    cmds:
      - task: "rebuild:backend"
      - task: "rebuild:ws"
      - echo ""
      - echo "‚úÖ All services rebuilt"

  # Legacy aliases (for backwards compatibility)
  update:backend:
    desc: (Deprecated - use rebuild:backend)
    cmds:
      - task: "rebuild:backend"

  update:ws:
    desc: (Deprecated - use rebuild:ws)
    cmds:
      - task: "rebuild:ws"

  update:all:
    desc: (Deprecated - use rebuild:all)
    cmds:
      - task: "rebuild:all"

  # === SSH ACCESS ===

  ssh:backend:
    desc: SSH into backend instance
    cmds:
      - gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}}

  ssh:ws:
    desc: SSH into WebSocket server instance
    cmds:
      - gcloud compute ssh {{.WS_INSTANCE}} --zone={{.GCP_ZONE}} --project={{.GCP_PROJECT}}
