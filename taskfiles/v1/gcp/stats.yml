version: '3'

# =============================================================================
# GCP Stats and Info Tasks
# =============================================================================
# Purpose: Display service URLs, IPs, and connection info
# Scope: Service discovery and access information

tasks:
  ip:backend:
    desc: Get backend instance IPs
    cmds:
      - |
        EXTERNAL_IP=$(gcloud compute instances describe {{.BACKEND_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --format="get(networkInterfaces[0].accessConfigs[0].natIP)")
        INTERNAL_IP=$(gcloud compute instances describe {{.BACKEND_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --format="get(networkInterfaces[0].networkIP)")

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Backend Instance: {{.BACKEND_INSTANCE}}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "External IP: $EXTERNAL_IP"
        echo "Internal IP: $INTERNAL_IP"

  ip:ws:
    desc: Get WebSocket server instance IPs
    cmds:
      - |
        EXTERNAL_IP=$(gcloud compute instances describe {{.WS_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --format="get(networkInterfaces[0].accessConfigs[0].natIP)")
        INTERNAL_IP=$(gcloud compute instances describe {{.WS_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --format="get(networkInterfaces[0].networkIP)")

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "WebSocket Server Instance: {{.WS_INSTANCE}}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "External IP: $EXTERNAL_IP"
        echo "Internal IP: $INTERNAL_IP"

  urls:
    desc: Get all service URLs
    cmds:
      - |
        BACKEND_IP=$(gcloud compute instances describe {{.BACKEND_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --format="get(networkInterfaces[0].accessConfigs[0].natIP)")
        WS_IP=$(gcloud compute instances describe {{.WS_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --format="get(networkInterfaces[0].accessConfigs[0].natIP)")

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸŒ SERVICE URLS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“Š BACKEND SERVICES ({{.BACKEND_INSTANCE}})"
        echo "   Grafana:              http://$BACKEND_IP:3010"
        echo "   Redpanda Console:     http://$BACKEND_IP:8080"
        echo "   Publisher:            http://$BACKEND_IP:3003/status"
        echo ""
        echo "ğŸŒ WEBSOCKET SERVER ({{.WS_INSTANCE}})"
        echo "   WebSocket:            ws://$WS_IP:3004/ws"
        echo "   Health:               http://$WS_IP:3004/health"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  info:
    desc: Show deployment information
    cmds:
      - |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸš€ GCP DEPLOYMENT INFO"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Project:  {{.GCP_PROJECT}}"
        echo "Region:   {{.GCP_REGION}}"
        echo "Zone:     {{.GCP_ZONE}}"
        echo ""
        echo "Backend:  {{.BACKEND_INSTANCE}} (e2-small)"
        echo "WS Server: {{.WS_INSTANCE}} (e2-standard-4)"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - task: urls
