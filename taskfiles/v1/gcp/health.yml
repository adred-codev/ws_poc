version: "3"

# =============================================================================
# GCP Health Check Tasks
# =============================================================================
# Purpose: Monitor service health on GCP instances
# Scope: Health endpoints, logs, service status

tasks:
  backend:
    desc: Check backend services health
    cmds:
      - echo "ğŸ¥ Checking backend health..."
      - |
        # Get backend external IP
        BACKEND_IP=$(gcloud compute instances describe {{.BACKEND_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --format="get(networkInterfaces[0].accessConfigs[0].natIP)")

        echo "Backend IP: $BACKEND_IP"
        echo ""

        # Check Publisher
        echo "ğŸ“Š Publisher Status:"
        (curl -sf http://$BACKEND_IP:3003/status | jq '.' || echo "âŒ Publisher not responding") || true
        echo ""

        # Check Redpanda health
        echo "ğŸ“Š Redpanda Health:"
        (gcloud compute ssh {{.BACKEND_INSTANCE}} --zone={{.GCP_ZONE}} --command="\
          docker exec redpanda rpk cluster health 2>/dev/null" || echo "âŒ Redpanda not responding") || true
        echo ""

        # Check Grafana
        echo "ğŸ“Š Grafana:"
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$BACKEND_IP:3010/api/health || echo "000")
        if [ "$STATUS" = "200" ]; then
          echo "âœ… Grafana: http://$BACKEND_IP:3010"
        else
          echo "âŒ Grafana not responding (HTTP $STATUS)"
        fi

  ws:
    desc: Check WebSocket server health
    cmds:
      - echo "ğŸ¥ Checking WebSocket server health..."
      - |
        # Get WS server external IP
        WS_IP=$(gcloud compute instances describe {{.WS_INSTANCE}} \
          --zone={{.GCP_ZONE}} \
          --format="get(networkInterfaces[0].accessConfigs[0].natIP)")

        echo "WebSocket Server IP: $WS_IP"
        echo ""

        # Check health endpoint
        echo "ğŸ“Š WebSocket Server Health:"
        (curl -sf http://$WS_IP:3004/health | jq '.' || echo "âŒ WebSocket server not responding") || true

  all:
    desc: Check all services health
    cmds:
      - task: backend
      - echo ""
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo ""
      - task: ws
