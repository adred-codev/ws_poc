version: '3'

# Local Health Check Tasks
# Individual health checks that compose into aggregate health check

tasks:
  redpanda:
    desc: Check Redpanda cluster health
    cmds:
      - |
        echo -n "ğŸ” Redpanda: "
        if docker exec redpanda-local rpk cluster health 2>/dev/null | grep -q "Healthy:.*true"; then
          echo "âœ… Healthy"
          exit 0
        else
          echo "âŒ Unhealthy"
          exit 1
        fi

  publisher:
    desc: Check Publisher health
    cmds:
      - |
        echo -n "ğŸ” Publisher: "
        if curl -sf http://localhost:3006/health > /dev/null 2>&1; then
          echo "âœ… Healthy"
          exit 0
        else
          echo "âŒ Unhealthy"
          exit 1
        fi

  ws:
    desc: Check WS server health
    cmds:
      - |
        echo -n "ğŸ” WS Server: "
        RESPONSE=$(curl -sf http://localhost:3005/health 2>/dev/null)
        if echo "$RESPONSE" | jq -e '.healthy == true' > /dev/null 2>&1; then
          echo "âœ… Healthy"
          exit 0
        else
          echo "âŒ Unhealthy"
          exit 1
        fi

  prometheus:
    desc: Check Prometheus health
    cmds:
      - |
        echo -n "ğŸ” Prometheus: "
        if curl -sf http://localhost:9092/-/healthy > /dev/null 2>&1; then
          echo "âœ… Healthy"
          exit 0
        else
          echo "âŒ Unhealthy"
          exit 1
        fi

  grafana:
    desc: Check Grafana health
    cmds:
      - |
        echo -n "ğŸ” Grafana: "
        if curl -sf http://localhost:3011/api/health > /dev/null 2>&1; then
          echo "âœ… Healthy"
          exit 0
        else
          echo "âŒ Unhealthy"
          exit 1
        fi

  loki:
    desc: Check Loki health
    cmds:
      - |
        echo -n "ğŸ” Loki: "
        if curl -sf http://localhost:3102/ready > /dev/null 2>&1; then
          echo "âœ… Healthy"
          exit 0
        else
          echo "âŒ Unhealthy"
          exit 1
        fi

  all:
    desc: Check health of all services (composed)
    cmds:
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo "ğŸ¥ HEALTH CHECK - LOCAL DEPLOYMENT"
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - task: redpanda
      - task: publisher
      - task: ws
      - task: prometheus
      - task: grafana
      - task: loki
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  detailed:
    desc: Detailed health check with full JSON responses
    cmds:
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo "ğŸ“Š DETAILED HEALTH CHECK"
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo ""
      - echo "ğŸ“¡ Publisher Health:"
      - curl -s http://localhost:3006/health | jq '.' || echo "âŒ Not responding"
      - echo ""
      - echo "ğŸŒ WS Server Health:"
      - curl -s http://localhost:3005/health | jq '.' || echo "âŒ Not responding"
      - echo ""
      - echo "ğŸ” Redpanda Cluster:"
      - docker exec redpanda-local rpk cluster health 2>/dev/null || echo "âŒ Not responding"
