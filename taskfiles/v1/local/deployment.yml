version: "3"

# Local Deployment Workflow Tasks
# Complete deployment workflows using composed tasks
# Mode-aware: Supports both single-core and multi-core deployments via WS_MODE env var

dotenv: ["{{.USER_WORKING_DIR}}/deployments/v1/local/.env.local"]

includes:
  services:
    taskfile: ./services.yml
    internal: true
  health:
    taskfile: ./health.yml
    internal: true

vars:
  WS_MODE: '{{.WS_MODE | default "single"}}'

tasks:
  setup:
    desc: Complete local deployment from scratch
    cmds:
      - echo "ğŸš€ Setting up local deployment..."
      - task: check-prerequisites
      - task: init-env
      - task: services:start:all
      - task: wait-for-health
      - task: create-topics
      - task: show-urls
      - echo "âœ… Local deployment ready!"

  check-prerequisites:
    desc: Check Docker and required tools
    cmds:
      - |
        echo "ğŸ” Checking prerequisites..."
        if ! docker info > /dev/null 2>&1; then
          echo "âŒ Docker not running"
          exit 1
        fi
        if ! docker-compose version > /dev/null 2>&1; then
          echo "âŒ docker-compose not found"
          exit 1
        fi
        echo "âœ… Prerequisites OK"

  init-env:
    desc: Initialize environment file
    cmds:
      - |
        cd {{.USER_WORKING_DIR}}/deployments/v1/local
        if [ ! -f .env.local ]; then
          echo "â„¹ï¸  .env.local will be created with secrets template"
        else
          echo "â„¹ï¸  .env.local already exists"
        fi

  wait-for-health:
    desc: Wait for all services to be healthy
    cmds:
      - echo "â³ Waiting for services to be healthy..."
      - |
        echo "Waiting for Redpanda..."
        for i in {1..30}; do
          if docker exec redpanda-local rpk cluster health 2>/dev/null | grep -q "Healthy:.*true"; then
            echo "âœ… Redpanda ready"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "âŒ Redpanda failed to become healthy"
            exit 1
          fi
          sleep 2
        done
      - sleep 5
      - echo "âœ… Services ready"

  create-topics:
    desc: Create Kafka topics
    cmds:
      - echo "ğŸ“ Creating Kafka topics..."
      - bash {{.USER_WORKING_DIR}}/scripts/v1/local/setup-redpanda-topics.sh redpanda-local

  show-urls:
    desc: Display service URLs
    cmds:
      - echo ""
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo "ğŸ”— SERVICE URLs (Mode: {{.WS_MODE}})"
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - echo "Redpanda Console â†’ http://localhost:8080"
      - echo "Publisher API    â†’ http://localhost:3006"
      - echo "WS Server        â†’ ws://localhost:3005"
      - echo "                    http://localhost:3005/health"
      - echo "Grafana          â†’ http://localhost:3011 (admin/admin)"
      - echo "Prometheus       â†’ http://localhost:9092"
      - echo "Loki             â†’ http://localhost:3102"
      - |
        if [ "{{.WS_MODE}}" = "multi" ]; then
          echo ""
          echo "Architecture: Multi-core (3 shards + load balancer)"
          echo "  â””â”€ Shard 0: internal port 3002"
          echo "  â””â”€ Shard 1: internal port 3003"
          echo "  â””â”€ Shard 2: internal port 3004"
          echo "  â””â”€ LoadBalancer: public port 3005"
        fi
      - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  reset:
    desc: Delete everything and redeploy (for config changes)
    cmds:
      - echo "âš ï¸  This will delete all containers and volumes!"
      - echo "   Press Ctrl+C to cancel, or wait 5 seconds..."
      - sleep 5
      - task: services:delete:all
      - echo "ğŸ”„ Redeploying..."
      - task: setup

  rebuild-code:
    desc: Rebuild services after code changes
    cmds:
      - echo "ğŸ”¨ Rebuilding services..."
      - task: services:rebuild:all
      - echo "ğŸ” Checking health..."
      - sleep 5
      - task: health:all
      - echo "âœ… Rebuild complete"

  quick-start:
    desc: Quick start (assumes topics exist)
    cmds:
      - echo "ğŸš€ Quick starting services..."
      - task: services:start:all
      - task: wait-for-health
      - task: health:all
      - task: show-urls

  stop:
    desc: Stop all services (keeps volumes)
    cmds:
      - docker-compose -f {{.USER_WORKING_DIR}}/deployments/v1/local/docker-compose.yml down
      - echo "âœ… Services stopped (volumes preserved)"
